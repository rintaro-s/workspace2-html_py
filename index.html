<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Çµ„Éº„ÇØ„É´ÁÆ°ÁêÜ„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É† - ÊúÄÂº∑„ÅÆÁµ±Âêà„Ç∑„Çπ„ÉÜ„É†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <style>
        :root {
            --sidebar-bg: #1a1a2e; --main-bg: #16213e; --header-bg: #0f3460;
            --dock-bg: rgba(15, 52, 96, 0.95); --subnav-bg: #1a1a2e;
            --text-primary: #e8e8e8; --text-secondary: #a0a0a0; --accent-blue: #0ea5e9;
            --accent-green: #10b981; --accent-orange: #f59e0b; --accent-red: #ef4444;
        }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, var(--main-bg) 0%, #0f172a 100%); color: var(--text-primary); overflow: hidden; font-size: 16px; }
        ::-webkit-scrollbar { width: 12px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 6px; }
        .lucide { stroke-width: 1.5px; }
        .server-icon { transition: all 0.3s ease; backdrop-filter: blur(10px); width: 64px; height: 64px; } 
        .server-icon:hover { border-radius: 35%; transform: scale(1.1); box-shadow: 0 12px 35px rgba(14, 165, 233, 0.4); }
        .server-icon.active { border-radius: 35% !important; box-shadow: 0 0 0 4px var(--accent-blue), 0 12px 35px rgba(14, 165, 233, 0.5); background: linear-gradient(135deg, var(--accent-blue), #06b6d4); }
        .dock-item { transition: all 0.3s ease; border-bottom: 4px solid transparent; backdrop-filter: blur(10px); padding: 20px 28px; font-size: 16px; }
        .dock-item:hover { color: white; background: rgba(255, 255, 255, 0.15); border-radius: 12px 12px 0 0; }
        .dock-item.active { color: white; border-bottom-color: var(--accent-blue); background: rgba(14, 165, 233, 0.25); }
        .subnav-item { padding: 12px 16px; margin: 4px 0; }
        .subnav-item:hover { background: rgba(255, 255, 255, 0.12); border-radius: 10px; }
        .subnav-item.active { background: linear-gradient(90deg, rgba(14, 165, 233, 0.4), rgba(6, 182, 212, 0.3)) !important; font-weight: 600; border-radius: 10px; }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 50; backdrop-filter: blur(5px); }
        .whiteboard-canvas { border: 3px solid rgba(255,255,255,0.2); border-radius: 16px; background: white; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
        .whiteboard-container { position: relative; width: 1200px; height: 800px; margin: 0 auto; }
        .whiteboard-tools { position: absolute; top: -60px; left: 0; right: 0; z-index: 10; display: flex; justify-content: center; gap: 8px; }
        .whiteboard-tool { padding: 12px; border-radius: 12px; background: rgba(0,0,0,0.8); color: white; border: none; cursor: pointer; transition: all 0.3s ease; }
        .whiteboard-tool:hover { background: rgba(14, 165, 233, 0.8); transform: scale(1.1); }
        .whiteboard-tool.active { background: var(--accent-blue); }
        .task-card { transition: all 0.3s ease; border-radius: 12px; border-left: 6px solid var(--accent-blue); padding: 20px; }
        .task-card:hover { transform: translateY(-4px); box-shadow: 0 12px 40px rgba(0,0,0,0.4); }
        .priority-high { border-left-color: var(--accent-red); background: rgba(239, 68, 68, 0.1); }
        .priority-medium { border-left-color: var(--accent-orange); background: rgba(245, 158, 11, 0.1); }
        .priority-low { border-left-color: var(--accent-green); background: rgba(16, 185, 129, 0.1); }
        .file-item { transition: all 0.3s ease; border-radius: 12px; padding: 16px; }
        .file-item:hover { background: rgba(255,255,255,0.1); transform: translateX(8px); box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .survey-question { background: rgba(255,255,255,0.08); border-radius: 16px; border: 2px solid rgba(255,255,255,0.2); padding: 24px; }
        .forum-post { background: rgba(255,255,255,0.05); border-radius: 12px; border-left: 4px solid var(--accent-blue); padding: 20px; }
        .glass-effect { background: rgba(255,255,255,0.08); backdrop-filter: blur(15px); border: 2px solid rgba(255,255,255,0.15); }
        .gradient-button { background: linear-gradient(135deg, var(--accent-blue), #06b6d4); transition: all 0.3s ease; padding: 12px 24px; border-radius: 12px; font-weight: 600; }
        .gradient-button:hover { transform: translateY(-2px); box-shadow: 0 12px 40px rgba(14, 165, 233, 0.5); }
        .wiki-page { background: rgba(255,255,255,0.06); border-radius: 16px; padding: 32px; border: 2px solid rgba(255,255,255,0.1); }
        .calendar-event { border-radius: 8px; padding: 8px 12px; margin: 2px 0; cursor: pointer; transition: all 0.2s; }
        .calendar-event:hover { transform: scale(1.02); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .budget-card { background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(14, 165, 233, 0.1)); border-radius: 16px; padding: 24px; border: 2px solid rgba(255,255,255,0.1); }
        .inventory-item { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 16px; border-left: 4px solid var(--accent-orange); }
        .member-card { background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1)); border-radius: 16px; padding: 20px; border: 2px solid rgba(255,255,255,0.1); }
        .album-photo { border-radius: 12px; overflow: hidden; transition: all 0.3s ease; }
        .album-photo:hover { transform: scale(1.05); box-shadow: 0 8px 32px rgba(0,0,0,0.4); }
        .diary-entry { background: rgba(255,255,255,0.06); border-radius: 16px; padding: 24px; border-left: 4px solid var(--accent-green); }
    </style>
</head>
<body class="h-screen w-screen text-sm">

    <div id="app" class="flex h-full w-full hidden">
        <!-- „Çµ„Éº„Éê„Éº„Çµ„Ç§„Éâ„Éê„Éº -->
        <nav id="server-bar" class="w-24 h-full flex-shrink-0 flex flex-col items-center py-6 space-y-6 bg-[var(--sidebar-bg)] glass-effect"></nav>
        
        <div class="flex-1 flex flex-col">
            <!-- „Éò„ÉÉ„ÉÄ„Éº -->
            <header id="header" class="h-20 flex-shrink-0 flex items-center justify-between px-8 bg-[var(--header-bg)] glass-effect border-b border-white/10"></header>
            
            <!-- Ê©üËÉΩ„Éâ„ÉÉ„ÇØ -->
            <nav id="feature-dock" class="h-16 flex-shrink-0 flex items-center px-6 space-x-4 bg-[var(--dock-bg)] border-b border-white/10"></nav>
            
            <!-- „É°„Ç§„É≥„Éì„É•„Éº -->
            <main id="main-view" class="flex-1 flex overflow-hidden">
                <aside id="sub-nav" class="w-80 h-full flex-shrink-0 bg-[var(--subnav-bg)] glass-effect p-4 overflow-y-auto border-r border-white/10"></aside>
                <div id="content-display" class="flex-1 overflow-hidden"></div>
            </main>
        </div>
    </div>

    <!-- Ë™çË®º„Ç≥„É≥„ÉÜ„Éä -->
    <div id="auth-container"></div>
    
    <!-- „É¢„Éº„ÉÄ„É´„Ç≥„É≥„ÉÜ„Éä -->
    <div id="modal-container"></div>
    
    <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
    <div id="loading-overlay" class="modal-backdrop hidden">
        <div class="flex flex-col items-center space-y-4">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-400"></div>
            <p class="text-blue-400 font-medium">Âá¶ÁêÜ‰∏≠...</p>
        </div>
    </div>
    
<script type="module">
    (function() {
        // === ÊúÄÂº∑„ÅÆ„Çµ„Éº„ÇØ„É´ÁÆ°ÁêÜ„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É† ===
        const API_ENDPOINT = '/api.cgi';
        let state = {};
        let loggedIn = false; // persistent flag to keep app visible when session was established
        let currentWhiteboardCanvas = null;
        let whiteboardSaveTimer = null;

        // === APIÈÄö‰ø°Èñ¢Êï∞ ===
        async function apiCall(action, params = {}) {
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) loadingOverlay.classList.remove('hidden');
            
            const formData = new FormData();
            formData.append('action', action);
            for (const key in params) { 
                if (params[key] !== null && params[key] !== undefined) {
                    formData.append(key, params[key]); 
                }
            }
            
            try {
                const response = await fetch(API_ENDPOINT, { 
                    method: 'POST', 
                    body: formData,
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                if (!result.success) {
                    const authError = document.getElementById('auth-error');
                    if (authError) authError.textContent = result.error || 'API call failed';
                    throw new Error(result.error || 'API call failed');
                }

                // Preserve currentUser when server returns a partial state
                const data = result.data;
                if (data && !data.currentUser && window.state && window.state.currentUser) {
                    data.currentUser = window.state.currentUser;
                }
                if (data && data.loggedIn) loggedIn = true;

                return data;
            } catch (error) {
                console.error('API Call Error:', error);
                if (action !== 'login' && action !== 'register' && action !== 'checkSession') {
                    showNotification(`„Ç®„É©„Éº: ${error.message}`, 'error');
                }
                return null;
            } finally {
                // hide loading overlay and clear any leftover modal backdrops as a fail-safe
                const loading = document.getElementById('loading-overlay');
                if (loading) loading.classList.add('hidden');
                // remove any modal-backdrop elements left in the DOM (except the loading overlay)
                document.querySelectorAll('.modal-backdrop').forEach(el => {
                    if (el.id === 'loading-overlay') return;
                    // remove the element
                    el.remove();
                });
                const modalContainer = document.getElementById('modal-container');
                if (modalContainer) modalContainer.innerHTML = '';
                // ensure app is visible if we have a logged-in state
                try {
                    // Keep app visible if we have an active session (or were logged in previously)
                    if ((window.state && window.state.currentUser) || loggedIn) {
                        document.getElementById('app').classList.remove('hidden');
                    }
                } catch (e) { /* ignore */ }
            }
        }

        // === ÈÄöÁü•„Ç∑„Çπ„ÉÜ„É† ===
        function showNotification(message, type = 'info', duration = 3000) {
            const notificationContainer = document.getElementById('notification-container') || createNotificationContainer();
            
            const notification = document.createElement('div');
            notification.className = `notification mb-2 p-4 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full ${
                type === 'error' ? 'bg-red-600 border-l-4 border-red-800' : 
                type === 'success' ? 'bg-green-600 border-l-4 border-green-800' : 
                type === 'warning' ? 'bg-yellow-600 border-l-4 border-yellow-800' :
                'bg-blue-600 border-l-4 border-blue-800'
            }`;
            
            const iconMap = {
                'success': 'check-circle',
                'error': 'x-circle',
                'warning': 'alert-triangle',
                'info': 'info'
            };
            
            notification.innerHTML = `
                <div class="flex items-center">
                    <i data-lucide="${iconMap[type]}" class="w-5 h-5 mr-3 flex-shrink-0"></i>
                    <span class="text-white font-medium">${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white/70 hover:text-white">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            `;
            
            notificationContainer.appendChild(notification);
            
            // Lucide„Ç¢„Ç§„Ç≥„É≥„ÇíÂÜçÂàùÊúüÂåñ
            if (window.lucide) {
                window.lucide.createIcons();
            }
            
            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÅßË°®Á§∫
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 50);
            
            // Ëá™ÂãïÂâäÈô§
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => notification.remove(), 300);
            }, duration);
        }

        function createNotificationContainer() {
            const container = document.createElement('div');
            container.id = 'notification-container';
            container.className = 'fixed top-4 right-4 z-50 max-w-sm';
            document.body.appendChild(container);
            return container;
        }

        // === „É¢„Éº„ÉÄ„É´ÂÆöÁæ© ===
        const MODALS = {
            'add-server': { 
                title: 'Êñ∞„Åó„ÅÑ„Çµ„Éº„ÇØ„É´„Çí‰ΩúÊàê', 
                fields: [
                    {name: 'name', placeholder: '„Çµ„Éº„ÇØ„É´Âêç', type: 'text'},
                    {name: 'icon', placeholder: '„Ç¢„Ç§„Ç≥„É≥ (ÁµµÊñáÂ≠ó)', type: 'text'}
                ] 
            },
            'add-subitem': { 
                title: 'Êñ∞„Åó„ÅÑ„ÉÅ„É£„É≥„Éç„É´/„Çπ„É¨„ÉÉ„Éâ„Çí‰ΩúÊàê', 
                fields: [
                    {name: 'name', placeholder: 'ÂêçÂâç', type: 'text'},
                    {name: 'type', placeholder: '„Çø„Ç§„Éó', type: 'select', options: [
                        {value: 'channel', label: '„ÉÅ„É£„É≥„Éç„É´'},
                        {value: 'thread', label: '„Çπ„É¨„ÉÉ„Éâ'}
                    ]}
                ] 
            },
            'add-whiteboard': {
                title: 'Êñ∞„Åó„ÅÑ„Éõ„ÉØ„Ç§„Éà„Éú„Éº„Éâ„Çí‰ΩúÊàê',
                fields: [{name: 'name', placeholder: '„Éú„Éº„ÉâÂêç', type: 'text'}]
            },
            'add-wiki-page': {
                title: 'Êñ∞„Åó„ÅÑWiki„Éö„Éº„Ç∏„Çí‰ΩúÊàê',
                fields: [
                    {name: 'title', placeholder: '„Éö„Éº„Ç∏„Çø„Ç§„Éà„É´', type: 'text'},
                    {name: 'content', placeholder: 'ÂÜÖÂÆπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ...', type: 'textarea'},
                    {name: 'tags', placeholder: '„Çø„Ç∞ („Ç´„É≥„ÉûÂå∫Âàá„Çä)', type: 'text'}
                ]
            },
            'create-event': {
                title: 'Êñ∞„Åó„ÅÑ„Ç§„Éô„É≥„Éà„Çí‰ΩúÊàê',
                fields: [
                    {name: 'title', placeholder: '„Ç§„Éô„É≥„Éà„Çø„Ç§„Éà„É´', type: 'text'},
                    {name: 'description', placeholder: 'Ë™¨Êòé', type: 'textarea'},
                    {name: 'date', placeholder: 'Êó•‰ªò', type: 'date'},
                    {name: 'time', placeholder: 'ÊôÇÈñì', type: 'time'}
                ]
            },
            'create-account': {
                title: 'Êñ∞„Åó„ÅÑ„Ç¢„Ç´„Ç¶„É≥„Éà„Çí‰ΩúÊàê',
                fields: [
                    {name: 'name', placeholder: '„Ç¢„Ç´„Ç¶„É≥„ÉàÂêç', type: 'text'},
                    {name: 'type', placeholder: '„Çø„Ç§„Éó', type: 'select', options: [
                        {value: 'checking', label: 'ÊôÆÈÄöÈ†êÈáë'},
                        {value: 'savings', label: 'ÂÆöÊúüÈ†êÈáë'},
                        {value: 'cash', label: 'ÁèæÈáë'}
                    ]},
                    {name: 'balance', placeholder: 'ÂàùÊúüÊÆãÈ´ò', type: 'number'}
                ]
            },
            'add-transaction': {
                title: 'ÂèñÂºï„ÇíËøΩÂä†',
                fields: [
                    {name: 'description', placeholder: 'Ë™¨Êòé', type: 'text'},
                    {name: 'amount', placeholder: 'ÈáëÈ°ç', type: 'number'},
                    {name: 'category', placeholder: '„Ç´„ÉÜ„Ç¥„É™', type: 'select', options: [
                        {value: 'income', label: 'ÂèéÂÖ•'},
                        {value: 'expense', label: 'ÊîØÂá∫'},
                        {value: 'transfer', label: 'ÊåØÊõø'}
                    ]},
                    {name: 'date', placeholder: 'Êó•‰ªò', type: 'date'}
                ]
            },
            'add-inventory-item': {
                title: 'Áâ©ÂìÅ„ÇíËøΩÂä†',
                fields: [
                    {name: 'name', placeholder: 'Áâ©ÂìÅÂêç', type: 'text'},
                    {name: 'category', placeholder: '„Ç´„ÉÜ„Ç¥„É™', type: 'select', options: [
                        {value: 'Ê©üÊùê', label: 'Ê©üÊùê'},
                        {value: 'ÂÇôÂìÅ', label: 'ÂÇôÂìÅ'},
                        {value: 'Êõ∏Á±ç', label: 'Êõ∏Á±ç'},
                        {value: 'ÈõªÂ≠êÊ©üÂô®', label: 'ÈõªÂ≠êÊ©üÂô®'},
                        {value: '„Åù„ÅÆ‰ªñ', label: '„Åù„ÅÆ‰ªñ'}
                    ]},
                    {name: 'quantity', placeholder: 'Êï∞Èáè', type: 'number'},
                    {name: 'unitPrice', placeholder: 'Âçò‰æ°', type: 'number'},
                    {name: 'minStock', placeholder: 'ÊúÄ‰ΩéÂú®Â∫´Êï∞', type: 'number'},
                    {name: 'location', placeholder: '‰øùÁÆ°Â†¥ÊâÄ', type: 'text'},
                    {name: 'status', placeholder: 'Áä∂ÊÖã', type: 'select', options: [
                        {value: 'available', label: 'Âà©Áî®ÂèØËÉΩ'},
                        {value: 'maintenance', label: '„É°„É≥„ÉÜ„Éä„É≥„Çπ‰∏≠'},
                        {value: 'damaged', label: 'Á†¥Êêç'},
                        {value: 'missing', label: 'Á¥õÂ§±'}
                    ]},
                    {name: 'description', placeholder: 'Ë™¨Êòé', type: 'textarea'}
                ]
            },
            'invite-member': {
                title: '„É°„É≥„Éê„Éº„ÇíÊãõÂæÖ',
                fields: [
                    {name: 'name', placeholder: 'ÂêçÂâç', type: 'text'},
                    {name: 'email', placeholder: '„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ', type: 'email'},
                    {name: 'nickname', placeholder: '„Éã„ÉÉ„ÇØ„Éç„Éº„É†', type: 'text'},
                    {name: 'admission_year', placeholder: 'ÂÖ•Â≠¶Âπ¥', type: 'number'},
                    {name: 'role', placeholder: 'ÂΩπÂâ≤', type: 'select', options: [
                        {value: 'member', label: '„É°„É≥„Éê„Éº'},
                        {value: 'admin', label: 'ÁÆ°ÁêÜËÄÖ'},
                        {value: 'moderator', label: '„É¢„Éá„É¨„Éº„Çø„Éº'}
                    ]}
                ]
            },
            'create-album': {
                title: '„Ç¢„É´„Éê„É†„Çí‰ΩúÊàê',
                fields: [
                    {name: 'title', placeholder: '„Ç¢„É´„Éê„É†Âêç', type: 'text'},
                    {name: 'description', placeholder: 'Ë™¨Êòé', type: 'textarea'}
                ]
            },
            'upload-photo': {
                title: 'ÂÜôÁúü„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ',
                fields: [
                    {name: 'title', placeholder: '„Çø„Ç§„Éà„É´', type: 'text'},
                    {name: 'url', placeholder: 'ÁîªÂÉèURL', type: 'url'}
                ]
            },
            'user-settings': {
                title: '„Éó„É≠„Éï„Ç£„Éº„É´Ë®≠ÂÆö',
                fields: [
                    {name: 'nickname', placeholder: '„Éã„ÉÉ„ÇØ„Éç„Éº„É†', type: 'text'},
                    {name: 'email', placeholder: '„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ', type: 'email'},
                    {name: 'admission_year', placeholder: 'ÂÖ•Â≠¶Âπ¥ (‰æã: 2024)', type: 'number'},
                    {name: 'graduation_year', placeholder: 'ÂçíÊ•≠‰∫àÂÆöÂπ¥ (‰æã: 2028)', type: 'number'},
                    {name: 'major', placeholder: 'Â∞ÇÊîª„ÉªÂ≠¶ÈÉ®', type: 'text'},
                    {name: 'student_id', placeholder: 'Â≠¶Á±çÁï™Âè∑', type: 'text'},
                    {name: 'bio', placeholder: 'Ëá™Â∑±Á¥π‰ªã', type: 'textarea'},
                    {name: 'ui_scale', placeholder: 'UI „Çµ„Ç§„Ç∫', type: 'select', options: [
                        {value: 'small', label: 'Â∞è'},
                        {value: 'medium', label: '‰∏≠'},
                        {value: 'large', label: 'Â§ß'}
                    ]},
                    {name: 'theme', placeholder: '„ÉÜ„Éº„Éû', type: 'select', options: [
                        {value: 'dark', label: '„ÉÄ„Éº„ÇØ'},
                        {value: 'light', label: '„É©„Ç§„Éà'}
                    ]},
                    {name: 'language', placeholder: 'Ë®ÄË™û', type: 'select', options: [
                        {value: 'ja', label: 'Êó•Êú¨Ë™û'},
                        {value: 'en', label: 'English'}
                    ]},
                    {name: 'timezone', placeholder: '„Çø„Ç§„É†„Çæ„Éº„É≥', type: 'select', options: [
                        {value: 'Asia/Tokyo', label: 'Êó•Êú¨Ê®ôÊ∫ñÊôÇ'},
                        {value: 'UTC', label: 'UTC'}
                    ]}
                ]
            },
            'password-recovery': {
                title: '„Éë„Çπ„ÉØ„Éº„ÉâÂæ©Êóß',
                fields: [
                    {name: 'username', placeholder: '„ÅÇ„Å™„Åü„ÅÆ„É¶„Éº„Ç∂„ÉºÂêç', type: 'text'},
                    {name: 'partnerUsername', placeholder: '„Éë„Éº„Éà„Éä„Éº„ÅÆ„É¶„Éº„Ç∂„ÉºÂêç', type: 'text'}
                ]
            },
            'create-invite': {
                title: '„Çµ„Éº„Éê„ÉºÊãõÂæÖ„Ç≥„Éº„Éâ„Çí‰ΩúÊàê',
                fields: []
            },
            'join-server': {
                title: '„Çµ„Éº„Éê„Éº„Å´ÂèÇÂä†',
                fields: [
                    {name: 'inviteCode', placeholder: 'ÊãõÂæÖ„Ç≥„Éº„Éâ', type: 'text'}
                ]
            },
            'create-survey': {
                title: '„Ç¢„É≥„Ç±„Éº„Éà„Çí‰ΩúÊàê',
                fields: [{name: 'title', placeholder: '„Ç¢„É≥„Ç±„Éº„Éà„Çø„Ç§„Éà„É´', type: 'text'}],
                custom: true
            },
            'create-project': {
                title: 'Êñ∞„Åó„ÅÑ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çí‰ΩúÊàê',
                fields: [
                    {name: 'name', placeholder: '„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç', type: 'text'},
                    {name: 'description', placeholder: 'Ë™¨Êòé', type: 'textarea'}
                ]
            },
            'create-task': {
                title: 'Êñ∞„Åó„ÅÑ„Çø„Çπ„ÇØ„Çí‰ΩúÊàê',
                fields: [
                    {name: 'title', placeholder: '„Çø„Çπ„ÇØ„Çø„Ç§„Éà„É´', type: 'text'},
                    {name: 'description', placeholder: 'Ë™¨Êòé', type: 'textarea'},
                    {name: 'priority', placeholder: 'ÂÑ™ÂÖàÂ∫¶', type: 'select', options: [
                        {value: 'low', label: '‰Ωé'},
                        {value: 'medium', label: '‰∏≠'},
                        {value: 'high', label: 'È´ò'}
                    ]}
                ]
            },
            'create-diary-entry': {
                title: 'Êó•Ë®ò„ÇíÊõ∏„Åè',
                fields: [
                    {name: 'title', placeholder: '„Çø„Ç§„Éà„É´', type: 'text'},
                    {name: 'content', placeholder: '‰ªäÊó•„ÅÆÂá∫Êù•‰∫ã„ÇÑÊÑüÊÉ≥„ÇíÊõ∏„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ...', type: 'textarea'},
                    {name: 'mood', placeholder: 'Ê∞óÂàÜ', type: 'select', options: [
                        {value: 'üòä', label: 'üòä Â¨â„Åó„ÅÑ'},
                        {value: 'üòå', label: 'üòå ÊôÆÈÄö'},
                        {value: 'üòî', label: 'üòî ÊÇ≤„Åó„ÅÑ'},
                        {value: 'üò§', label: 'üò§ ÊÄí„Çä'},
                        {value: 'üò¥', label: 'üò¥ Áú†„ÅÑ'},
                        {value: 'ü§î', label: 'ü§î ËÄÉ„Åà‰∏≠'}
                    ]},
                    {name: 'tags', placeholder: '„Çø„Ç∞ („Ç´„É≥„ÉûÂå∫Âàá„Çä)', type: 'text'},
                    {name: 'private', placeholder: '„Éó„É©„Ç§„Éô„Éº„Éà', type: 'checkbox'}
                ]
            }
        };
        
        // === „É¢„Éº„ÉÄ„É´Ë°®Á§∫Èñ¢Êï∞ ===
        const showModal = (type, customData = null) => {
            return new Promise((resolve) => {
                const modalInfo = MODALS[type];
                if (!modalInfo) return resolve(null);
                
                const modalContainer = document.getElementById('modal-container');
                let modalHTML = `
                    <div class="modal-backdrop">
                        <div class="glass-effect p-8 rounded-xl shadow-2xl w-full max-w-lg space-y-6">
                            <h2 class="text-2xl font-bold text-center">${modalInfo.title}</h2>
                            <form id="modal-form" class="space-y-4">`;

                if (type === 'create-survey') {
                    modalHTML += `
                        <input type="text" name="title" placeholder="„Ç¢„É≥„Ç±„Éº„Éà„Çø„Ç§„Éà„É´" required class="w-full bg-white/10 p-3 rounded-lg border border-white/20 focus:border-blue-400 focus:outline-none">
                        <div id="questions-container" class="space-y-3">
                            <div class="question-item">
                                <input type="text" name="question_0" placeholder="Ë≥™Âïè 1" required class="w-full bg-white/10 p-3 rounded-lg border border-white/20 mb-2">
                                <select name="type_0" class="w-full bg-white/10 p-3 rounded-lg border border-white/20">
                                    <option value="text">„ÉÜ„Ç≠„Çπ„ÉàÂõûÁ≠î</option>
                                    <option value="radio">Âçò‰∏ÄÈÅ∏Êäû</option>
                                    <option value="checkbox">Ë§áÊï∞ÈÅ∏Êäû</option>
                                    <option value="rating">Ë©ï‰æ°Ôºà1-5Ôºâ</option>
                                </select>
                                <div class="options-container mt-2 hidden">
                                    <input type="text" name="options_0" placeholder="ÈÅ∏ÊäûËÇ¢Ôºà„Ç´„É≥„ÉûÂå∫Âàá„ÇäÔºâ" class="w-full bg-white/10 p-2 rounded-lg border border-white/20">
                                </div>
                            </div>
                        </div>
                        <button type="button" id="add-question" class="w-full bg-green-600 hover:bg-green-700 p-2 rounded-lg font-medium">Ë≥™Âïè„ÇíËøΩÂä†</button>`;
                } else {
                    modalInfo.fields.forEach((field, index) => {
                        if (field.type === 'select') {
                            modalHTML += `
                                <select name="${field.name}" required class="w-full bg-white/10 p-3 rounded-lg border border-white/20 focus:border-blue-400 focus:outline-none">
                                    <option value="">${field.placeholder}</option>
                                    ${field.options.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('')}
                                </select>`;
                        } else if (field.type === 'textarea') {
                            modalHTML += `<textarea name="${field.name}" placeholder="${field.placeholder}" rows="3" class="w-full bg-white/10 p-3 rounded-lg border border-white/20 focus:border-blue-400 focus:outline-none resize-none"></textarea>`;
                        } else {
                            modalHTML += `<input type="${field.type}" name="${field.name}" placeholder="${field.placeholder}" required class="w-full bg-white/10 p-3 rounded-lg border border-white/20 focus:border-blue-400 focus:outline-none">`;
                        }
                    });
                }

                modalHTML += `
                                <div class="flex justify-end space-x-3 pt-4">
                                    <button type="button" data-action="close-modal" class="px-6 py-2 rounded-lg bg-gray-600 hover:bg-gray-700 font-medium transition-colors">„Ç≠„É£„É≥„Çª„É´</button>
                                    <button type="submit" class="px-6 py-2 rounded-lg gradient-button font-medium text-white">‰ΩúÊàê</button>
                                </div>
                            </form>
                        </div>
                    </div>`;

                modalContainer.innerHTML = modalHTML;
                
                const form = document.getElementById('modal-form');
                form.querySelector('input, select, textarea').focus();
                
                // „Ç¢„É≥„Ç±„Éº„ÉàË≥™ÂïèËøΩÂä†Ê©üËÉΩ
                if (type === 'create-survey') {
                    let questionCount = 1;
                    document.getElementById('add-question').addEventListener('click', () => {
                        const container = document.getElementById('questions-container');
                        const questionHTML = `
                            <div class="question-item">
                                <input type="text" name="question_${questionCount}" placeholder="Ë≥™Âïè ${questionCount + 1}" required class="w-full bg-white/10 p-3 rounded-lg border border-white/20 mb-2">
                                <select name="type_${questionCount}" class="w-full bg-white/10 p-3 rounded-lg border border-white/20">
                                    <option value="text">„ÉÜ„Ç≠„Çπ„ÉàÂõûÁ≠î</option>
                                    <option value="radio">Âçò‰∏ÄÈÅ∏Êäû</option>
                                    <option value="checkbox">Ë§áÊï∞ÈÅ∏Êäû</option>
                                    <option value="rating">Ë©ï‰æ°Ôºà1-5Ôºâ</option>
                                </select>
                                <div class="options-container mt-2 hidden">
                                    <input type="text" name="options_${questionCount}" placeholder="ÈÅ∏ÊäûËÇ¢Ôºà„Ç´„É≥„ÉûÂå∫Âàá„ÇäÔºâ" class="w-full bg-white/10 p-2 rounded-lg border border-white/20">
                                </div>
                            </div>`;
                        container.insertAdjacentHTML('beforeend', questionHTML);
                        questionCount++;
                    });

                    // „Çø„Ç§„ÉóÂ§âÊõ¥ÊôÇ„ÅÆÈÅ∏ÊäûËÇ¢Ë°®Á§∫Âàá„ÇäÊõø„Åà
                    form.addEventListener('change', (e) => {
                        if (e.target.name.startsWith('type_')) {
                            const container = e.target.closest('.question-item').querySelector('.options-container');
                            if (e.target.value === 'radio' || e.target.value === 'checkbox') {
                                container.classList.remove('hidden');
                            } else {
                                container.classList.add('hidden');
                            }
                        }
                    });
                }
                
                const close = () => { modalContainer.innerHTML = ''; resolve(null); };
                
                form.addEventListener('submit', e => { 
                    e.preventDefault(); 
                    const formData = new FormData(form); 
                    const result = {};
                    
                    if (type === 'create-survey') {
                        result.title = formData.get('title');
                        result.questions = [];
                        let i = 0;
                        while (formData.get(`question_${i}`)) {
                            const question = {
                                id: i,
                                text: formData.get(`question_${i}`),
                                type: formData.get(`type_${i}`),
                                options: formData.get(`options_${i}`) ? formData.get(`options_${i}`).split(',').map(s => s.trim()) : []
                            };
                            result.questions.push(question);
                            i++;
                        }
                    } else {
                        for(const [key, value] of formData.entries()) { 
                            result[key] = value; 
                        }
                    }
                    
                    modalContainer.innerHTML = ''; 
                    resolve(result); 
                });
                
                modalContainer.querySelector('[data-action="close-modal"]').addEventListener('click', close);
            });
        };

        // === „ÉÜ„É≥„Éó„É¨„Éº„ÉàÂÆöÁæ© ===
        const TEMPLATES = {
            auth: () => `
                <div class="modal-backdrop">
                    <div class="glass-effect p-10 rounded-2xl shadow-2xl w-full max-w-md">
                        <h1 class="text-4xl font-bold text-center mb-8 bg-gradient-to-r from-blue-400 to-cyan-400 bg-clip-text text-transparent">„Çµ„Éº„ÇØ„É´ÁÆ°ÁêÜ„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†</h1>
                        <div id="auth-error" class="text-red-400 text-center mb-6 h-5"></div>
                        <form id="login-form" class="space-y-4">
                            <input type="text" name="username" placeholder="„É¶„Éº„Ç∂„ÉºÂêç" required class="w-full bg-white/10 p-4 rounded-xl border border-white/20 focus:border-blue-400 focus:outline-none transition-colors">
                            <input type="password" name="password" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ" required class="w-full bg-white/10 p-4 rounded-xl border border-white/20 focus:border-blue-400 focus:outline-none transition-colors">
                            <button type="submit" class="w-full gradient-button p-4 rounded-xl font-bold text-white">„É≠„Ç∞„Ç§„É≥</button>
                        </form>
                        <div class="flex flex-col space-y-2 mt-4">
                            <p class="text-center text-sm text-gray-400">„Ç¢„Ç´„Ç¶„É≥„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÅãÔºü <a href="#" data-action="showRegister" class="text-blue-400 hover:underline">Êñ∞Ë¶èÁôªÈå≤</a></p>
                            <p class="text-center text-sm text-gray-400">„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂøò„Çå„Åæ„Åó„Åü„ÅãÔºü <a href="#" data-action="showPasswordRecovery" class="text-red-400 hover:underline">„Éë„Çπ„ÉØ„Éº„ÉâÂæ©Êóß</a></p>
                        </div>
                    </div>
                </div>`,
            
            register: () => `
                <div class="modal-backdrop">
                    <div class="glass-effect p-10 rounded-2xl shadow-2xl w-full max-w-md">
                        <h1 class="text-4xl font-bold text-center mb-8 bg-gradient-to-r from-green-400 to-blue-400 bg-clip-text text-transparent">Êñ∞Ë¶èÁôªÈå≤</h1>
                        <div id="auth-error" class="text-red-400 text-center mb-6 h-5"></div>
                        <form id="register-form" class="space-y-4">
                            <input type="text" name="username" placeholder="„É¶„Éº„Ç∂„ÉºÂêçÔºà3ÊñáÂ≠ó‰ª•‰∏äÔºâ" required class="w-full bg-white/10 p-4 rounded-xl border border-white/20 focus:border-blue-400 focus:outline-none transition-colors">
                            <input type="password" name="password" placeholder="„Éë„Çπ„ÉØ„Éº„ÉâÔºà6ÊñáÂ≠ó‰ª•‰∏äÔºâ" required class="w-full bg-white/10 p-4 rounded-xl border border-white/20 focus:border-blue-400 focus:outline-none transition-colors">
                            <button type="submit" class="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 p-4 rounded-xl font-bold text-white transition-all">ÁôªÈå≤</button>
                        </form>
                        <p class="text-center text-sm text-gray-400 mt-6">„Ç¢„Ç´„Ç¶„É≥„Éà„Çí„ÅäÊåÅ„Å°„Åß„Åô„ÅãÔºü <a href="#" data-action="showLogin" class="text-blue-400 hover:underline">„É≠„Ç∞„Ç§„É≥</a></p>
                    </div>
                </div>`,

            userHub: (state) => {
                // ÂÖ®„Çµ„Éº„ÇØ„É´„Åã„ÇâËá™ÂàÜ„ÅÆ„Çø„Çπ„ÇØ„Å®„Ç§„Éô„É≥„Éà„ÇíÂèéÈõÜ
                const myTasks = [];
                const myEvents = [];
                const todayStr = new Date().toISOString().split('T')[0];
                
                Object.values(state.servers).forEach(server => {
                    if (state.features[server.id]) {
                        state.features[server.id].forEach(feature => {
                            const content = state.content[feature.id];
                            if (!content) return;
                            
                            // „Çø„Çπ„ÇØ„ÇíÂèéÈõÜ
                            if (content.tasks) {
                                Object.values(content.tasks).forEach(task => {
                                    if (task.assigned_to === state.currentUser.name || task.created_by === state.currentUser.name) {
                                        myTasks.push({...task, serverName: server.name, featureName: feature.name});
                                    }
                                });
                            }
                            
                            // „Ç§„Éô„É≥„Éà„ÇíÂèéÈõÜ
                            if (content.events) {
                                Object.values(content.events).forEach(event => {
                                    if (event.date >= todayStr) {
                                        myEvents.push({...event, serverName: server.name, featureName: feature.name});
                                    }
                                });
                            }
                        });
                    }
                });
                
                // ‰ªäÊó•„Å®‰ªäÈÄ±„ÅÆ„Ç§„Éô„É≥„Éà„ÇíÂàÜÈ°û
                const today = new Date();
                const weekFromNow = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
                
                const todayEvents = myEvents.filter(e => e.date === todayStr);
                const upcomingEvents = myEvents.filter(e => e.date > todayStr && new Date(e.date) <= weekFromNow);
                const pendingTasks = myTasks.filter(t => t.status === 'pending' || t.status === 'in_progress');
                
                return `
                <div class="p-8 h-full overflow-y-auto bg-gradient-to-br from-blue-500/10 to-cyan-500/10">
                    <div class="max-w-7xl mx-auto space-y-8">
                        <!-- „Éò„ÉÉ„ÉÄ„Éº -->
                        <div class="text-center space-y-4">
                            <div class="flex items-center justify-between">
                                <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-400 via-cyan-400 to-green-400 bg-clip-text text-transparent">
                                    „Çà„ÅÜ„Åì„Åù„ÄÅ${state.currentUser.nickname || state.currentUser.username}„Åï„Çì
                                </h1>
                                <button onclick="openSettings()" class="btn">
                                    <i data-lucide="settings" class="w-5 h-5 mr-2"></i>
                                    Ë®≠ÂÆö
                                </button>
                            </div>
                            <p class="text-lg text-gray-300">‰ªäÊó•„ÅØ${today.toLocaleDateString('ja-JP', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})}„Åß„Åô</p>
                        </div>

                        <!-- Áµ±Ë®à„Ç´„Éº„Éâ -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                            <div class="glass-effect p-6 rounded-xl">
                                <div class="flex items-center space-x-3">
                                    <i data-lucide="calendar" class="w-8 h-8 text-blue-400"></i>
                                    <div>
                                        <p class="text-2xl font-bold text-white">${todayEvents.length}</p>
                                        <p class="text-sm text-gray-400">‰ªäÊó•„ÅÆ„Ç§„Éô„É≥„Éà</p>
                                    </div>
                                </div>
                            </div>
                            <div class="glass-effect p-6 rounded-xl">
                                <div class="flex items-center space-x-3">
                                    <i data-lucide="clock" class="w-8 h-8 text-yellow-400"></i>
                                    <div>
                                        <p class="text-2xl font-bold text-white">${upcomingEvents.length}</p>
                                        <p class="text-sm text-gray-400">‰ªäÈÄ±„ÅÆ„Ç§„Éô„É≥„Éà</p>
                                    </div>
                                </div>
                            </div>
                            <div class="glass-effect p-6 rounded-xl">
                                <div class="flex items-center space-x-3">
                                    <i data-lucide="check-square" class="w-8 h-8 text-green-400"></i>
                                    <div>
                                        <p class="text-2xl font-bold text-white">${pendingTasks.length}</p>
                                        <p class="text-sm text-gray-400">Êú™ÂÆå‰∫Ü„Çø„Çπ„ÇØ</p>
                                    </div>
                                </div>
                            </div>
                            <div class="glass-effect p-6 rounded-xl">
                                <div class="flex items-center space-x-3">
                                    <i data-lucide="users" class="w-8 h-8 text-purple-400"></i>
                                    <div>
                                        <p class="text-2xl font-bold text-white">${Object.keys(state.servers).length}</p>
                                        <p class="text-sm text-gray-400">ÂèÇÂä†„Çµ„Éº„ÇØ„É´</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- ‰ªäÊó•„ÅÆ„Ç§„Éô„É≥„Éà -->
                            <div class="glass-effect p-6 rounded-xl">
                                <h2 class="text-xl font-bold text-white mb-4 flex items-center">
                                    <i data-lucide="calendar-days" class="w-5 h-5 mr-2"></i>
                                    ‰ªäÊó•„ÅÆ„Ç§„Éô„É≥„Éà
                                </h2>
                                <div class="space-y-3">
                                    ${todayEvents.length > 0 ? todayEvents.map(event => `
                                        <div class="bg-blue-500/20 p-4 rounded-lg border border-blue-500/30">
                                            <div class="flex justify-between items-start">
                                                <div>
                                                    <h3 class="font-semibold text-white">${event.title}</h3>
                                                    <p class="text-sm text-gray-300">${event.serverName} - ${event.featureName}</p>
                                                    <p class="text-sm text-blue-300">${event.time}</p>
                                                </div>
                                                <span class="bg-blue-500 text-white text-xs px-2 py-1 rounded">‰ªäÊó•</span>
                                            </div>
                                        </div>
                                    `).join('') : '<p class="text-gray-400 text-center py-4">‰ªäÊó•„ÅÆ‰∫àÂÆö„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>'}
                                </div>
                            </div>

                            <!-- Êú™ÂÆå‰∫Ü„Çø„Çπ„ÇØ -->
                            <div class="glass-effect p-6 rounded-xl">
                                <h2 class="text-xl font-bold text-white mb-4 flex items-center">
                                    <i data-lucide="list-todo" class="w-5 h-5 mr-2"></i>
                                    Êú™ÂÆå‰∫Ü„Çø„Çπ„ÇØ
                                </h2>
                                <div class="space-y-3">
                                    ${pendingTasks.slice(0, 5).length > 0 ? pendingTasks.slice(0, 5).map(task => `
                                        <div class="bg-yellow-500/20 p-4 rounded-lg border border-yellow-500/30">
                                            <div class="flex justify-between items-start">
                                                <div>
                                                    <h3 class="font-semibold text-white">${task.title}</h3>
                                                    <p class="text-sm text-gray-300">${task.serverName} - ${task.featureName}</p>
                                                    ${task.due_date ? `<p class="text-sm text-yellow-300">ÊúüÈôê: ${task.due_date}</p>` : ''}
                                                </div>
                                                <span class="bg-${task.priority === 'high' ? 'red' : task.priority === 'medium' ? 'yellow' : 'green'}-500 text-white text-xs px-2 py-1 rounded capitalize">${task.priority || 'medium'}</span>
                                            </div>
                                        </div>
                                    `).join('') : '<p class="text-gray-400 text-center py-4">Êú™ÂÆå‰∫Ü„Çø„Çπ„ÇØ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>'}
                                </div>
                            </div>

                            <!-- ‰ªäÈÄ±„ÅÆ„Ç§„Éô„É≥„Éà -->
                            <div class="glass-effect p-6 rounded-xl">
                                <h2 class="text-xl font-bold text-white mb-4 flex items-center">
                                    <i data-lucide="calendar-range" class="w-5 h-5 mr-2"></i>
                                    ‰ªäÈÄ±„ÅÆ„Ç§„Éô„É≥„Éà
                                </h2>
                                <div class="space-y-3">
                                    ${upcomingEvents.slice(0, 5).length > 0 ? upcomingEvents.slice(0, 5).map(event => `
                                        <div class="bg-purple-500/20 p-4 rounded-lg border border-purple-500/30">
                                            <div class="flex justify-between items-start">
                                                <div>
                                                    <h3 class="font-semibold text-white">${event.title}</h3>
                                                    <p class="text-sm text-gray-300">${event.serverName} - ${event.featureName}</p>
                                                    <p class="text-sm text-purple-300">${new Date(event.date).toLocaleDateString('ja-JP')} ${event.time}</p>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('') : '<p class="text-gray-400 text-center py-4">‰ªäÈÄ±„ÅÆ‰∫àÂÆö„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>'}
                                </div>
                            </div>

                            <!-- „ÇØ„Ç§„ÉÉ„ÇØ„Ç¢„ÇØ„Ç∑„Éß„É≥ -->
                            <div class="glass-effect p-6 rounded-xl">
                                <h2 class="text-xl font-bold text-white mb-4 flex items-center">
                                    <i data-lucide="zap" class="w-5 h-5 mr-2"></i>
                                    „ÇØ„Ç§„ÉÉ„ÇØ„Ç¢„ÇØ„Ç∑„Éß„É≥
                                </h2>
                                <div class="grid grid-cols-2 gap-3">
                                    <button class="btn w-full">
                                        <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                                        Êñ∞Ë¶è„Çµ„Éº„ÇØ„É´
                                    </button>
                                    <button class="btn-secondary w-full">
                                        <i data-lucide="search" class="w-4 h-4 mr-2"></i>
                                        „Çµ„Éº„ÇØ„É´Ê§úÁ¥¢
                                    </button>
                                    <button class="btn-secondary w-full">
                                        <i data-lucide="bell" class="w-4 h-4 mr-2"></i>
                                        ÈÄöÁü•Ë®≠ÂÆö
                                    </button>
                                    <button class="btn-secondary w-full">
                                        <i data-lucide="help-circle" class="w-4 h-4 mr-2"></i>
                                        „Éò„É´„Éó
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            },

            sub_nav: (feature, content, state) => {
                if (!content) return '';
                
                let navHTML = `<div class="mb-4">
                    <h3 class="text-lg font-semibold mb-3 flex items-center">
                        <i data-lucide="${feature.icon}" class="w-5 h-5 mr-2 text-blue-400"></i>
                        ${feature.name}
                    </h3>`;

                if (feature.type === 'chat' || feature.type === 'forum') {
                    navHTML += `<button data-action="add-subitem" class="w-full text-sm p-3 rounded-lg glass-effect hover:bg-white/10 mb-4 gradient-button font-medium">
                        <i data-lucide="plus" class="w-4 h-4 inline mr-2"></i>
                        ${feature.type === 'chat' ? '„ÉÅ„É£„É≥„Éç„É´ËøΩÂä†' : '„Çπ„É¨„ÉÉ„ÉâËøΩÂä†'}
                    </button>`;
                    
                    if (content.subItems) {
                        Object.entries(content.subItems).forEach(([id, item]) => {
                            const iconMap = { chat: 'hash', forum: 'message-circle' };
                            const icon = iconMap[feature.type] || 'circle';
                            navHTML += `<a href="#" data-subitem-id="${id}" class="subnav-item flex items-center space-x-3 px-3 py-2 rounded-lg transition-all ${id === state.activeSubItemId ? 'active':''}">
                                <i data-lucide="${icon}" class="w-4 h-4 text-gray-400"></i>
                                <span class="truncate">${item.name}</span>
                                ${item.messages && item.messages.length ? `<span class="bg-blue-500 text-xs px-2 py-1 rounded-full ml-auto">${item.messages.length}</span>` : ''}
                            </a>`;
                        });
                    }
                } else if (feature.type === 'whiteboard') {
                    navHTML += `<button data-action="add-whiteboard" class="w-full text-sm p-3 rounded-lg glass-effect hover:bg-white/10 mb-4 gradient-button font-medium">
                        <i data-lucide="plus" class="w-4 h-4 inline mr-2"></i>
                        „Éú„Éº„ÉâËøΩÂä†
                    </button>`;
                    
                    if (content.boards) {
                        Object.entries(content.boards).forEach(([id, board]) => {
                            navHTML += `<a href="#" data-board-id="${id}" class="subnav-item flex items-center space-x-3 px-3 py-2 rounded-lg transition-all ${id === state.activeBoardId ? 'active':''}">
                                <i data-lucide="edit-3" class="w-4 h-4 text-gray-400"></i>
                                <span class="truncate">${board.name}</span>
                            </a>`;
                        });
                    }
                } else if (feature.type === 'survey') {
                    navHTML += `<button data-action="create-survey" class="w-full text-sm p-3 rounded-lg glass-effect hover:bg-white/10 mb-4 gradient-button font-medium">
                        <i data-lucide="plus" class="w-4 h-4 inline mr-2"></i>
                        „Ç¢„É≥„Ç±„Éº„Éà‰ΩúÊàê
                    </button>`;
                    
                    if (content.surveys) {
                        Object.entries(content.surveys).forEach(([id, survey]) => {
                            navHTML += `<a href="#" data-survey-id="${id}" class="subnav-item flex items-center space-x-3 px-3 py-2 rounded-lg transition-all ${id === state.activeSurveyId ? 'active':''}">
                                <i data-lucide="clipboard-list" class="w-4 h-4 text-gray-400"></i>
                                <span class="truncate">${survey.title}</span>
                                <span class="text-xs text-gray-500">${survey.status}</span>
                            </a>`;
                        });
                    }
                }
                else if (feature.type === 'projects') {
                    navHTML += `<button data-action="create-project" class="w-full text-sm p-3 rounded-lg glass-effect hover:bg-white/10 mb-4 gradient-button font-medium">
                        <i data-lucide="plus" class="w-4 h-4 inline mr-2"></i>
                        Create Project
                    </button>`;
                    
                    if (content.projects) {
                        Object.entries(content.projects).forEach(([id, project]) => {
                            navHTML += `<a href="#" data-project-id="${id}" class="subnav-item flex items-center space-x-3 px-3 py-2 rounded-lg transition-all ${id === state.activeProjectId ? 'active':''}">
                                <i data-lucide="git-branch" class="w-4 h-4 text-gray-400"></i>
                                <span class="truncate">${project.name}</span>
                                <span class="text-xs text-gray-500">${project.status}</span>
                            </a>`;
                        });
                    }
                } else if (feature.type === 'wiki') {
                    navHTML += `<button data-action="create-wiki-page" class="w-full text-sm p-3 rounded-lg glass-effect hover:bg-white/10 mb-4 gradient-button font-medium">
                        <i data-lucide="plus" class="w-4 h-4 inline mr-2"></i>
                        New Page
                    </button>`;
                    
                    if (content.pages) {
                        Object.entries(content.pages).forEach(([id, page]) => {
                            navHTML += `<a href="#" data-wiki-page-id="${id}" class="subnav-item flex items-center space-x-3 px-3 py-2 rounded-lg transition-all ${id === state.activeWikiPageId ? 'active':''}">
                                <i data-lucide="file-text" class="w-4 h-4 text-gray-400"></i>
                                <span class="truncate">${page.title}</span>
                            </a>`;
                        });
                    }
                } else if (feature.type === 'calendar') {
                    navHTML += `<button data-action="create-event" class="w-full text-sm p-3 rounded-lg glass-effect hover:bg-white/10 mb-4 gradient-button font-medium">
                        <i data-lucide="plus" class="w-4 h-4 inline mr-2"></i>
                        Add Event
                    </button>`;
                    
                    navHTML += `<div class="space-y-1">
                        <div class="text-sm font-medium text-gray-400 mb-2">Views</div>
                        <a href="#" data-calendar-view="month" class="subnav-item flex items-center space-x-3 px-3 py-2 rounded-lg transition-all active">
                            <i data-lucide="calendar" class="w-4 h-4 text-blue-400"></i>
                            <span>Month View</span>
                        </a>
                        <a href="#" data-calendar-view="week" class="subnav-item flex items-center space-x-3 px-3 py-2 rounded-lg transition-all">
                            <i data-lucide="calendar-days" class="w-4 h-4 text-gray-400"></i>
                            <span>Week View</span>
                        </a>
                    </div>`;
                } else if (feature.type === 'budget') {
                    navHTML += `<button data-action="add-transaction" class="w-full text-sm p-3 rounded-lg glass-effect hover:bg-white/10 mb-4 gradient-button font-medium">
                        <i data-lucide="plus" class="w-4 h-4 inline mr-2"></i>
                        Add Transaction
                    </button>`;
                    
                    navHTML += `<div class="space-y-1">
                        <div class="text-sm font-medium text-gray-400 mb-2">Accounts</div>`;
                    
                    if (content.accounts) {
                        Object.entries(content.accounts).forEach(([id, account]) => {
                            navHTML += `<a href="#" data-account-id="${id}" class="subnav-item flex items-center justify-between px-3 py-2 rounded-lg transition-all">
                                <div class="flex items-center space-x-3">
                                    <i data-lucide="dollar-sign" class="w-4 h-4 text-green-400"></i>
                                    <span class="truncate">${account.name}</span>
                                </div>
                                <span class="text-xs text-gray-500">$${account.balance}</span>
                            </a>`;
                        });
                    }
                    navHTML += `</div>`;
                } else if (feature.type === 'members') {
                    navHTML += `<button data-action="invite-member" class="w-full text-sm p-3 rounded-lg glass-effect hover:bg-white/10 mb-4 gradient-button font-medium">
                        <i data-lucide="user-plus" class="w-4 h-4 inline mr-2"></i>
                        Invite Member
                    </button>`;
                    
                    navHTML += `<div class="space-y-1">
                        <div class="text-sm font-medium text-gray-400 mb-2">Roles</div>`;
                    
                    if (content.roles) {
                        Object.entries(content.roles).forEach(([roleId, role]) => {
                            const memberCount = content.members ? 
                                Object.values(content.members).filter(m => m.role === roleId).length : 0;
                            navHTML += `<a href="#" data-role-filter="${roleId}" class="subnav-item flex items-center justify-between px-3 py-2 rounded-lg transition-all">
                                <div class="flex items-center space-x-3">
                                    <i data-lucide="users" class="w-4 h-4 text-blue-400"></i>
                                    <span class="truncate">${role.name}</span>
                                </div>
                                <span class="text-xs text-gray-500">${memberCount}</span>
                            </a>`;
                        });
                    }
                    navHTML += `</div>`;
                } else if (feature.type === 'inventory') {
                    navHTML += `<button data-action="add-inventory-item" class="w-full text-sm p-3 rounded-lg glass-effect hover:bg-white/10 mb-4 gradient-button font-medium">
                        <i data-lucide="plus" class="w-4 h-4 inline mr-2"></i>
                        Add Item
                    </button>`;
                    
                    navHTML += `<div class="space-y-1">
                        <div class="text-sm font-medium text-gray-400 mb-2">Categories</div>`;
                    
                    if (content.categories) {
                        content.categories.forEach(category => {
                            const itemCount = content.items ? 
                                Object.values(content.items).filter(item => item.category === category).length : 0;
                            navHTML += `<a href="#" data-category-filter="${category}" class="subnav-item flex items-center justify-between px-3 py-2 rounded-lg transition-all">
                                <div class="flex items-center space-x-3">
                                    <i data-lucide="package" class="w-4 h-4 text-orange-400"></i>
                                    <span class="truncate">${category}</span>
                                </div>
                                <span class="text-xs text-gray-500">${itemCount}</span>
                            </a>`;
                        });
                    }
                    navHTML += `</div>`;
                } else if (feature.type === 'album') {
                    navHTML += `<button data-action="create-album" class="w-full text-sm p-3 rounded-lg glass-effect hover:bg-white/10 mb-4 gradient-button font-medium">
                        <i data-lucide="plus" class="w-4 h-4 inline mr-2"></i>
                        New Album
                    </button>`;
                    
                    if (content.albums) {
                        Object.entries(content.albums).forEach(([id, album]) => {
                            navHTML += `<a href="#" data-album-id="${id}" class="subnav-item flex items-center space-x-3 px-3 py-2 rounded-lg transition-all ${id === state.activeAlbumId ? 'active':''}">
                                <i data-lucide="image" class="w-4 h-4 text-pink-400"></i>
                                <span class="truncate">${album.title}</span>
                                <span class="text-xs text-gray-500">${album.photos?.length || 0}</span>
                            </a>`;
                        });
                    }
                } else if (feature.type === 'diary') {
                    navHTML += `<button data-action="create-diary-entry" class="w-full text-sm p-3 rounded-lg glass-effect hover:bg-white/10 mb-4 gradient-button font-medium">
                        <i data-lucide="plus" class="w-4 h-4 inline mr-2"></i>
                        New Entry
                    </button>`;
                    
                    navHTML += `<div class="space-y-1">
                        <div class="text-sm font-medium text-gray-400 mb-2">Recent Entries</div>`;
                    
                    if (content.entries) {
                        const sortedEntries = Object.values(content.entries)
                            .sort((a, b) => b.created_at - a.created_at)
                            .slice(0, 10);
                        
                        sortedEntries.forEach(entry => {
                            navHTML += `<a href="#" data-diary-entry-id="${entry.id}" class="subnav-item flex items-center space-x-3 px-3 py-2 rounded-lg transition-all">
                                <i data-lucide="edit" class="w-4 h-4 text-teal-400"></i>
                                <span class="truncate">${entry.title}</span>
                            </a>`;
                        });
                    }
                    navHTML += `</div>`;
                }

                navHTML += '</div>';
                return navHTML;
            },
            content: (feature, content, subItem, state) => {
                if (!feature) return '';

                if (feature.type === 'chat' && subItem) {
                    return `
                        <div class="h-full flex flex-col bg-gradient-to-br from-gray-900/50 to-blue-900/20">
                            <div class="border-b border-white/10 p-4 glass-effect">
                                <h2 class="text-xl font-semibold flex items-center">
                                    <i data-lucide="hash" class="w-5 h-5 mr-2 text-blue-400"></i>
                                    ${subItem.name}
                                </h2>
                            </div>
                            <div id="message-list" class="flex-1 p-6 space-y-4 overflow-y-auto">
                                ${(subItem.messages || []).map(m => {
                                    const isOwn = m.authorId === state.currentUser.username;
                                    return `
                                        <div class="flex items-end space-x-3 ${isOwn ? 'justify-end' : ''}">
                                            ${!isOwn ? `<div class="w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-cyan-500 flex items-center justify-center text-white font-bold text-sm">${m.authorName[0].toUpperCase()}</div>` : ''}
                                            <div class="max-w-lg p-4 rounded-2xl ${isOwn ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-br-none' : 'glass-effect rounded-bl-none'}">
                                                ${!isOwn ? `<p class="font-semibold text-sm mb-1 text-blue-400">${m.authorName}</p>` : ''}
                                                <p class="whitespace-pre-wrap">${m.content}</p>
                                                <p class="text-xs opacity-70 mt-2">${new Date(m.timestamp * 1000).toLocaleTimeString()}</p>
                                            </div>
                                            ${isOwn ? `<div class="w-8 h-8 rounded-full bg-gradient-to-r from-green-500 to-blue-500 flex items-center justify-center text-white font-bold text-sm">${m.authorName[0].toUpperCase()}</div>` : ''}
                                        </div>`;
                                }).join('')}
                            </div>
                            <div class="p-4 border-t border-white/10 glass-effect">
                                <div class="flex space-x-3">
                                    <input data-action="post-message" class="flex-1 bg-white/10 p-3 rounded-xl border border-white/20 focus:border-blue-400 focus:outline-none transition-colors" placeholder="${subItem.name}„Å´„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°...">
                                    <button class="gradient-button px-6 py-3 rounded-xl font-medium">
                                        <i data-lucide="send" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                        </div>`;
                }
                else if (feature.type === 'whiteboard') {
                    const boards = content?.boards || {};
                    const activeBoardId = state.activeBoardId || Object.keys(boards)[0];
                    const activeBoard = boards[activeBoardId];
                    
                    if (!activeBoard) {
                        return `
                            <div class="h-full flex items-center justify-center">
                                <div class="text-center space-y-6">
                                    <i data-lucide="edit-3" class="w-20 h-20 mx-auto text-gray-500"></i>
                                    <p class="text-2xl font-semibold">„Éõ„ÉØ„Ç§„Éà„Éú„Éº„Éâ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                                    <p class="text-gray-400 text-lg">Êñ∞„Åó„ÅÑ„Éõ„ÉØ„Ç§„Éà„Éú„Éº„Éâ„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                                </div>
                            </div>`;
                    }

                    return `
                        <div class="h-full flex flex-col bg-gradient-to-br from-gray-900/50 to-blue-900/20">
                            <div class="border-b border-white/10 p-6 glass-effect">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h1 class="text-3xl font-bold text-white mb-2">${activeBoard.name}</h1>
                                        <p class="text-gray-300">ÂÖ±Âêå‰ΩúÊ•≠„Éõ„ÉØ„Ç§„Éà„Éú„Éº„Éâ</p>
                                    </div>
                                    <div class="flex space-x-3">
                                        <button data-action="whiteboard-save" class="btn">
                                            <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                                            ‰øùÂ≠ò
                                        </button>
                                        <button data-action="whiteboard-export" class="btn-secondary">
                                            <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                                            „Ç®„ÇØ„Çπ„Éù„Éº„Éà
                                        </button>
                                        <button data-action="whiteboard-clear" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg text-white">
                                            <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>
                                            „ÇØ„É™„Ç¢
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="flex-1 p-6">
                                <div class="flex space-x-4 mb-4 items-center bg-black/20 p-4 rounded-lg">
                                    <div class="flex space-x-2">
                                        <button data-tool="pen" class="whiteboard-tool active bg-blue-600 text-white px-3 py-2 rounded" title="„Éö„É≥">
                                            <i data-lucide="pen-tool" class="w-4 h-4"></i>
                                        </button>
                                        <button data-tool="eraser" class="whiteboard-tool bg-gray-600 text-white px-3 py-2 rounded" title="Ê∂à„Åó„Ç¥„É†">
                                            <i data-lucide="eraser" class="w-4 h-4"></i>
                                        </button>
                                        <button data-tool="text" class="whiteboard-tool bg-gray-600 text-white px-3 py-2 rounded" title="„ÉÜ„Ç≠„Çπ„Éà">
                                            <i data-lucide="type" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <label class="text-white text-sm">Ëâ≤:</label>
                                        <input type="color" id="pen-color" value="#000000" class="w-8 h-8 rounded cursor-pointer">
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <label class="text-white text-sm">Â§™„Åï:</label>
                                        <input type="range" id="pen-size" min="1" max="20" value="3" class="w-20">
                                        <span id="pen-size-display" class="text-white text-sm w-6">3</span>
                                    </div>
                                </div>
                                <div class="relative bg-white rounded-lg shadow-lg" style="height: calc(100vh - 300px);">
                                    <canvas id="simple-whiteboard" class="absolute inset-0 w-full h-full cursor-crosshair"></canvas>
                                </div>
                            </div>
                        </div>`;
                }
                else if (feature.type === 'storage') {
                    const folders = content?.folders || { root: { name: '„É´„Éº„Éà', files: [], subfolders: [] } };
                    const currentFolderId = content?.currentFolder || 'root';
                    const currentFolder = folders[currentFolderId] || folders.root;
                    const breadcrumb = getBreadcrumb(folders, currentFolderId);
                    const files = state?.files || [];
                    const serverFiles = files.filter(f => f.serverId === state.activeServerId && f.featureId === state.activeFeatureId);
                    
                    return `
                        <div class="h-full flex flex-col bg-gradient-to-br from-blue-900/20 to-indigo-900/20">
                            <div class="border-b border-white/10 p-6 glass-effect">
                                <div class="flex justify-between items-center mb-4">
                                    <div>
                                        <h2 class="text-2xl font-bold text-white flex items-center">
                                            <i data-lucide="folder" class="w-6 h-6 mr-2 text-yellow-400"></i>
                                            „Éï„Ç°„Ç§„É´ÂÖ±Êúâ
                                        </h2>
                                        <div class="flex items-center space-x-2 text-sm text-gray-400 mt-2">
                                            ${breadcrumb.map((folder, index) => `
                                                <span class="flex items-center">
                                                    ${index > 0 ? '<i data-lucide="chevron-right" class="w-4 h-4 mx-1"></i>' : ''}
                                                    <button onclick="navigateToFolder('${folder.id}')" class="hover:text-white transition-colors">
                                                        ${folder.name}
                                                    </button>
                                                </span>
                                            `).join('')}
                                        </div>
                                    </div>
                                    <div class="flex space-x-3">
                                        <button onclick="createFolder()" class="bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded-lg font-medium transition-all text-white">
                                            <i data-lucide="folder-plus" class="w-4 h-4 mr-2"></i>
                                            „Éï„Ç©„É´„ÉÄ‰ΩúÊàê
                                        </button>
                                        <button data-action="upload-file" class="gradient-button px-4 py-2 rounded-lg font-medium">
                                            <i data-lucide="upload" class="w-4 h-4 mr-2"></i>
                                            „Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex-1 p-6 overflow-y-auto">
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6 gap-4">
                                    <!-- „Éï„Ç©„É´„ÉÄË°®Á§∫ -->
                                    ${(currentFolder?.subfolders || []).map(subfolder => `
                                        <div class="file-item glass-effect p-4 cursor-pointer group relative hover:bg-yellow-600/10 transition-all" onclick="navigateToFolder('${subfolder.id}')">
                                            <button onclick="deleteFolder('${subfolder.id}')" class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity text-red-400 hover:text-red-300 w-6 h-6 flex items-center justify-center z-10" title="„Éï„Ç©„É´„ÉÄÂâäÈô§" onclick="event.stopPropagation()">√ó</button>
                                            <div class="flex flex-col items-center space-y-2">
                                                <i data-lucide="folder" class="w-12 h-12 text-yellow-400"></i>
                                                <p class="font-medium text-center text-white">${subfolder.name}</p>
                                                <p class="text-xs text-gray-400">${subfolder.files?.length || 0} „Éï„Ç°„Ç§„É´</p>
                                            </div>
                                        </div>
                                    `).join('')}
                                    
                                    <!-- „Éï„Ç°„Ç§„É´Ë°®Á§∫ -->
                                    ${serverFiles.map(file => {
                                        const extension = file.filename.split('.').pop().toLowerCase();
                                        const iconMap = {
                                            'pdf': 'file-text',
                                            'doc': 'file-text', 'docx': 'file-text',
                                            'xls': 'file-spreadsheet', 'xlsx': 'file-spreadsheet',
                                            'ppt': 'presentation', 'pptx': 'presentation',
                                            'jpg': 'image', 'jpeg': 'image', 'png': 'image', 'gif': 'image',
                                            'mp4': 'video', 'avi': 'video', 'mov': 'video',
                                            'mp3': 'music', 'wav': 'music',
                                            'zip': 'archive', 'rar': 'archive', '7z': 'archive'
                                        };
                                        const icon = iconMap[extension] || 'file';
                                        
                                        return `
                                            <div class="file-item glass-effect p-4 cursor-pointer group relative hover:bg-blue-600/10 transition-all" data-file-id="${file.id}">
                                                <button onclick="deleteFile('${file.id}')" class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity text-red-400 hover:text-red-300 w-6 h-6 flex items-center justify-center z-10" title="„Éï„Ç°„Ç§„É´ÂâäÈô§">√ó</button>
                                                <div class="flex flex-col items-center space-y-2">
                                                    <i data-lucide="${icon}" class="w-12 h-12 text-blue-400"></i>
                                                    <p class="font-medium text-center text-white text-sm truncate w-full" title="${file.filename}">${file.filename}</p>
                                                    <div class="text-xs text-gray-400 text-center">
                                                        <p>${formatFileSize(file.size)}</p>
                                                        <p>${new Date(file.uploadedAt).toLocaleDateString('ja-JP')}</p>
                                                    </div>
                                                    <button onclick="downloadFile('${file.id}', '${file.filename}')" class="text-green-400 hover:text-green-300 p-1 opacity-0 group-hover:opacity-100 transition-opacity" title="„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ">
                                                        <i data-lucide="download" class="w-4 h-4"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                    
                                    ${serverFiles.length === 0 && (currentFolder?.subfolders || []).length === 0 ? 
                                        '<div class="col-span-full text-center text-gray-400 py-12"><i data-lucide="folder-open" class="w-12 h-12 mx-auto mb-4 text-gray-500"></i><p>„Åì„ÅÆ„Éï„Ç©„É´„ÉÄ„ÅØÁ©∫„Åß„Åô</p></div>' : ''}
                                </div>
                            </div>
                        </div>`;
                }
                else if (feature.type === 'survey') {
                    const surveys = content?.surveys || {};
                    const activeSurveyId = state.activeSurveyId || Object.keys(surveys)[0];
                    const activeSurvey = surveys[activeSurveyId];
                    
                    if (!activeSurvey) {
                        return `
                            <div class="h-full flex items-center justify-center">
                                <div class="text-center space-y-4">
                                    <i data-lucide="clipboard-list" class="w-16 h-16 mx-auto text-gray-500"></i>
                                    <p class="text-xl font-semibold">„Ç¢„É≥„Ç±„Éº„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                                    <p class="text-gray-400">Â∑¶„ÅÆ„Çµ„Ç§„Éâ„Éê„Éº„Åã„ÇâÊñ∞„Åó„ÅÑ„Ç¢„É≥„Ç±„Éº„Éà„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                                </div>
                            </div>`;
                    }

                    const responses = content?.responses?.[activeSurveyId] || {};
                    const hasResponded = responses[state.currentUser.username];
                    const showResults = state.showSurveyResults || false;

                    return `
                        <div class="h-full flex">
                            <!-- „É°„Ç§„É≥ÂõûÁ≠î„Ç®„É™„Ç¢ -->
                            <div class="flex-1 flex flex-col">
                                <div class="border-b border-white/10 p-6 glass-effect">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <h2 class="text-2xl font-bold text-white mb-2">${activeSurvey.title}</h2>
                                            <p class="text-gray-400">‰ΩúÊàêËÄÖ: ${activeSurvey.created_by} | ÂõûÁ≠îÊï∞: ${Object.keys(responses).length}‰∫∫</p>
                                            <p class="text-xs text-gray-500 mt-1">‰ΩúÊàêÊó•: ${new Date(activeSurvey.created_at * 1000).toLocaleDateString('ja-JP')}</p>
                                        </div>
                                        <div class="flex space-x-3">
                                            <button onclick="toggleSurveyResults()" class="btn-secondary">
                                                <i data-lucide="bar-chart" class="w-4 h-4 mr-2"></i>
                                                ${showResults ? 'ÂõûÁ≠îÁîªÈù¢' : 'ÁµêÊûú„ÇíË¶ã„Çã'}
                                            </button>
                                            <button onclick="deleteSurvey('${activeSurveyId}')" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg text-white">
                                                <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>
                                                ÂâäÈô§
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="flex-1 p-6 overflow-y-auto">
                                    ${!showResults ? `
                                        ${hasResponded ? `
                                            <div class="bg-green-600/20 border border-green-600/30 rounded-lg p-4 mb-6">
                                                <p class="text-green-400 font-medium">‚úì ÂõûÁ≠îÊ∏à„Åø - ÁµêÊûú„ÇíÁ¢∫Ë™ç„Åô„Çã„Å´„ÅØ„ÄåÁµêÊûú„ÇíË¶ã„Çã„Äç„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                                            </div>
                                        ` : ''}
                                        <form id="survey-form" class="space-y-6">
                                            ${activeSurvey.questions.map((q, index) => `
                                                <div class="survey-question p-6">
                                                    <label class="block text-lg font-medium mb-4">${index + 1}. ${q.text}</label>
                                                    ${q.type === 'text' ? `
                                                        <textarea name="q${q.id}" class="w-full bg-white/10 p-3 rounded-lg border border-white/20 focus:border-blue-400 focus:outline-none resize-none" rows="3" ${hasResponded ? 'disabled' : ''} placeholder="Ëá™Áî±Ë®òËø∞ÂõûÁ≠î"></textarea>
                                                    ` : q.type === 'radio' ? `
                                                        <div class="space-y-3">
                                                            ${q.options.map((option, optIndex) => `
                                                                <label class="flex items-center space-x-3 cursor-pointer p-2 rounded hover:bg-white/5">
                                                                    <input type="radio" name="q${q.id}" value="${option}" class="text-blue-600" ${hasResponded ? 'disabled' : ''}>
                                                                    <span class="text-white">${option}</span>
                                                                </label>
                                                            `).join('')}
                                                        </div>
                                                    ` : q.type === 'checkbox' ? `
                                                        <div class="space-y-3">
                                                            ${q.options.map(option => `
                                                                <label class="flex items-center space-x-3 cursor-pointer p-2 rounded hover:bg-white/5">
                                                                    <input type="checkbox" name="q${q.id}" value="${option}" class="text-blue-600" ${hasResponded ? 'disabled' : ''}>
                                                                    <span class="text-white">${option}</span>
                                                                </label>
                                                            `).join('')}
                                                        </div>
                                                    ` : q.type === 'rating' ? `
                                                        <div class="flex space-x-2 justify-center">
                                                            ${[1,2,3,4,5].map(rating => `
                                                                <label class="flex flex-col items-center cursor-pointer group">
                                                                    <input type="radio" name="q${q.id}" value="${rating}" class="sr-only" ${hasResponded ? 'disabled' : ''}>
                                                                    <span class="w-12 h-12 rounded-full border-2 border-gray-600 flex items-center justify-center group-hover:border-blue-400 group-hover:bg-blue-400/20 transition-all text-white font-bold">${rating}</span>
                                                                    <span class="text-xs text-gray-400 mt-1">${rating === 1 ? 'ÊÇ™„ÅÑ' : rating === 5 ? 'ËâØ„ÅÑ' : ''}</span>
                                                                </label>
                                                            `).join('')}
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            `).join('')}
                                            ${!hasResponded ? `
                                                <button type="submit" class="w-full gradient-button p-4 rounded-lg font-medium text-white text-lg">
                                                    <i data-lucide="send" class="w-5 h-5 mr-2"></i>
                                                    ÂõûÁ≠î„ÇíÈÄÅ‰ø°
                                                </button>
                                            ` : ''}
                                        </form>
                                    ` : `
                                        <!-- ÁµêÊûúË°®Á§∫ -->
                                        <div class="space-y-8">
                                            <div class="bg-blue-600/20 border border-blue-600/30 rounded-lg p-6">
                                                <h3 class="text-xl font-bold text-white mb-2">üìä „Ç¢„É≥„Ç±„Éº„ÉàÁµêÊûú</h3>
                                                <p class="text-blue-300">ÂêàË®à ${Object.keys(responses).length} ‰∫∫„ÅåÂõûÁ≠î„Åó„Åæ„Åó„Åü</p>
                                            </div>
                                            
                                            ${activeSurvey.questions.map((q, qIndex) => {
                                                // „Éá„Éê„ÉÉ„Ç∞Áî®„É≠„Ç∞Âá∫Âäõ
                                                console.log('Survey responses for question', q.id, ':', responses);
                                                
                                                const qResponses = Object.values(responses || {}).map(userResponse => {
                                                    try {
                                                        // ÊñáÂ≠óÂàó„ÅÆÂ†¥Âêà„ÅØJSON„Éë„Éº„Çπ
                                                        const parsed = typeof userResponse === 'string' ? JSON.parse(userResponse) : userResponse;
                                                        return parsed[q.id];
                                                    } catch (e) {
                                                        console.warn('Failed to parse response:', userResponse, e);
                                                        return userResponse[q.id];
                                                    }
                                                }).filter(r => r !== undefined && r !== null && r !== '');
                                                
                                                if (q.type === 'text') {
                                                    return `
                                                        <div class="bg-white/5 p-6 rounded-lg">
                                                            <h4 class="text-lg font-semibold text-white mb-4">${qIndex + 1}. ${q.text}</h4>
                                                            <div class="space-y-3 max-h-60 overflow-y-auto">
                                                                ${qResponses.map(response => `
                                                                    <div class="bg-white/10 p-3 rounded border-l-4 border-blue-400">
                                                                        <p class="text-gray-200">"${response}"</p>
                                                                    </div>
                                                                `).join('')}
                                                            </div>
                                                        </div>
                                                    `;
                                                } else if (q.type === 'radio' || q.type === 'checkbox') {
                                                    const optionCounts = {};
                                                    q.options.forEach(opt => optionCounts[opt] = 0);
                                                    qResponses.forEach(response => {
                                                        if (Array.isArray(response)) {
                                                            response.forEach(r => { if (optionCounts[r] !== undefined) optionCounts[r]++; });
                                                        } else {
                                                            if (optionCounts[response] !== undefined) optionCounts[response]++;
                                                        }
                                                    });
                                                    
                                                    const total = Object.values(optionCounts).reduce((a, b) => a + b, 0);
                                                    
                                                    return `
                                                        <div class="bg-white/5 p-6 rounded-lg">
                                                            <h4 class="text-lg font-semibold text-white mb-4">${qIndex + 1}. ${q.text}</h4>
                                                            <div class="space-y-3">
                                                                ${Object.entries(optionCounts).map(([option, count]) => {
                                                                    const percentage = total > 0 ? Math.round((count / total) * 100) : 0;
                                                                    return `
                                                                        <div class="flex items-center justify-between">
                                                                            <span class="text-white">${option}</span>
                                                                            <div class="flex items-center space-x-3 flex-1 ml-4">
                                                                                <div class="flex-1 bg-gray-700 rounded-full h-3">
                                                                                    <div class="bg-gradient-to-r from-blue-500 to-cyan-500 h-3 rounded-full transition-all" style="width: ${percentage}%"></div>
                                                                                </div>
                                                                                <span class="text-sm text-gray-300 w-16 text-right">${count}‰∫∫ (${percentage}%)</span>
                                                                            </div>
                                                                        </div>
                                                                    `;
                                                                }).join('')}
                                                            </div>
                                                        </div>
                                                    `;
                                                } else if (q.type === 'rating') {
                                                    const ratingCounts = {1: 0, 2: 0, 3: 0, 4: 0, 5: 0};
                                                    qResponses.forEach(response => {
                                                        const rating = parseInt(response);
                                                        if (ratingCounts[rating] !== undefined) ratingCounts[rating]++;
                                                    });
                                                    
                                                    const total = Object.values(ratingCounts).reduce((a, b) => a + b, 0);
                                                    const average = total > 0 ? (Object.entries(ratingCounts).reduce((sum, [rating, count]) => sum + (parseInt(rating) * count), 0) / total).toFixed(1) : 0;
                                                    
                                                    return `
                                                        <div class="bg-white/5 p-6 rounded-lg">
                                                            <h4 class="text-lg font-semibold text-white mb-4">${qIndex + 1}. ${q.text}</h4>
                                                            <div class="mb-4">
                                                                <div class="text-center">
                                                                    <span class="text-3xl font-bold text-yellow-400">${average}</span>
                                                                    <span class="text-gray-400 ml-2">/ 5.0 (${total}‰∫∫„ÅåÂõûÁ≠î)</span>
                                                                </div>
                                                            </div>
                                                            <div class="space-y-2">
                                                                ${[5,4,3,2,1].map(rating => {
                                                                    const count = ratingCounts[rating];
                                                                    const percentage = total > 0 ? Math.round((count / total) * 100) : 0;
                                                                    return `
                                                                        <div class="flex items-center space-x-3">
                                                                            <span class="text-yellow-400 w-8">${rating}‚òÖ</span>
                                                                            <div class="flex-1 bg-gray-700 rounded-full h-2">
                                                                                <div class="bg-gradient-to-r from-yellow-400 to-orange-500 h-2 rounded-full transition-all" style="width: ${percentage}%"></div>
                                                                            </div>
                                                                            <span class="text-sm text-gray-300 w-16 text-right">${count}‰∫∫</span>
                                                                        </div>
                                                                    `;
                                                                }).join('')}
                                                            </div>
                                                        </div>
                                                    `;
                                                }
                                                return '';
                                            }).join('')}
                                        </div>
                                    `}
                                </div>
                            </div>
                        </div>`;
                }
                else if (feature.type === 'forum' && subItem) {
                    return `
                        <div class="h-full flex flex-col">
                            <div class="border-b border-white/10 p-4 glass-effect">
                                <h2 class="text-xl font-semibold flex items-center">
                                    <i data-lucide="message-circle" class="w-5 h-5 mr-2 text-orange-400"></i>
                                    ${subItem.name}
                                </h2>
                            </div>
                            <div class="flex-1 p-6 space-y-4 overflow-y-auto">
                                ${(subItem.posts || []).map((post, index) => `
                                    <div class="forum-post p-4">
                                        <div class="flex items-start space-x-3">
                                            <div class="w-10 h-10 rounded-full bg-gradient-to-r from-orange-500 to-red-500 flex items-center justify-center text-white font-bold">
                                                ${post.authorName ? post.authorName[0].toUpperCase() : 'A'}
                                            </div>
                                            <div class="flex-1">
                                                <div class="flex items-center space-x-2 mb-2">
                                                    <span class="font-semibold">${post.authorName || 'Anonymous'}</span>
                                                    <span class="text-xs text-gray-400">#${index + 1}</span>
                                                    <span class="text-xs text-gray-400">${new Date(post.timestamp * 1000).toLocaleString()}</span>
                                                </div>
                                                <p class="whitespace-pre-wrap">${post.content}</p>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="p-4 border-t border-white/10 glass-effect">
                                <textarea data-action="post-forum-message" class="w-full bg-white/10 p-3 rounded-lg border border-white/20 focus:border-blue-400 focus:outline-none resize-none" rows="3" placeholder="${subItem.name}„Å´ÊäïÁ®ø..."></textarea>
                                <button class="mt-2 gradient-button px-6 py-2 rounded-lg font-medium">ÊäïÁ®ø</button>
                            </div>
                        </div>`;
                }
                else if (feature.type === 'projects') {
                    const projects = content?.projects || {};
                    const activeProjectId = state.activeProjectId || Object.keys(projects)[0];
                    const activeProject = projects[activeProjectId];
                    const tasks = content?.tasks || {};
                    const projectTasks = Object.values(tasks).filter(task => task.project_id === activeProjectId);
                    
                    if (!activeProject) {
                        return `
                            <div class="h-full flex items-center justify-center">
                                <div class="text-center space-y-4">
                                    <i data-lucide="git-branch" class="w-16 h-16 mx-auto text-gray-500"></i>
                                    <p class="text-xl font-semibold">„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                                    <p class="text-gray-400">Â∑¶„ÅÆ„Çµ„Ç§„Éâ„Éê„Éº„Åã„ÇâÊñ∞„Åó„ÅÑ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                                </div>
                            </div>`;
                    }

                    const todoTasks = projectTasks.filter(task => task.status === 'todo');
                    const inProgressTasks = projectTasks.filter(task => task.status === 'in-progress');
                    const doneTasks = projectTasks.filter(task => task.status === 'done');

                    return `
                        <div class="h-full flex flex-col">
                            <div class="border-b border-white/10 p-4 glass-effect flex justify-between items-center">
                                <div>
                                    <h2 class="text-xl font-semibold flex items-center">
                                        <i data-lucide="git-branch" class="w-5 h-5 mr-2 text-green-400"></i>
                                        ${activeProject.name}
                                    </h2>
                                    <p class="text-sm text-gray-400 mt-1">${activeProject.description}</p>
                                </div>
                                <button data-action="create-task" class="gradient-button px-4 py-2 rounded-lg font-medium">
                                    <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                                    „Çø„Çπ„ÇØËøΩÂä†
                                </button>
                            </div>
                            <div class="flex-1 p-6 overflow-y-auto">
                                <div class="grid grid-cols-3 gap-6 h-full">
                                    <div class="space-y-4">
                                        <h3 class="font-semibold text-gray-400 flex items-center">
                                            <div class="w-3 h-3 bg-gray-500 rounded-full mr-2"></div>
                                            TODO (${todoTasks.length})
                                        </h3>
                                        <div class="space-y-3">
                                            ${todoTasks.map(task => `
                                                <div class="task-card glass-effect p-4 cursor-pointer priority-${task.priority}" data-task-id="${task.id}">
                                                    <h4 class="font-medium mb-2">${task.title}</h4>
                                                    <p class="text-sm text-gray-400 mb-3">${task.description}</p>
                                                    <div class="flex justify-between items-center text-xs">
                                                        <span class="bg-${task.priority === 'high' ? 'red' : task.priority === 'medium' ? 'yellow' : 'green'}-600/20 text-${task.priority === 'high' ? 'red' : task.priority === 'medium' ? 'yellow' : 'green'}-400 px-2 py-1 rounded">${task.priority}</span>
                                                        <div class="flex space-x-1">
                                                            <button data-action="update-task-status" data-task-id="${task.id}" data-status="in-progress" class="text-blue-400 hover:text-blue-300 p-1" title="ÈÄ≤Ë°å‰∏≠„Å´ÁßªÂãï">‚Üí</button>
                                                            <button onclick="deleteTask('${task.id}')" class="text-red-400 hover:text-red-300 p-1" title="ÂâäÈô§">√ó</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                    <div class="space-y-4">
                                        <h3 class="font-semibold text-blue-400 flex items-center">
                                            <div class="w-3 h-3 bg-blue-500 rounded-full mr-2"></div>
                                            ÈÄ≤Ë°å‰∏≠ (${inProgressTasks.length})
                                        </h3>
                                        <div class="space-y-3">
                                            ${inProgressTasks.map(task => `
                                                <div class="task-card glass-effect p-4 cursor-pointer priority-${task.priority}" data-task-id="${task.id}">
                                                    <h4 class="font-medium mb-2">${task.title}</h4>
                                                    <p class="text-sm text-gray-400 mb-3">${task.description}</p>
                                                    <div class="flex justify-between items-center text-xs">
                                                        <span class="bg-${task.priority === 'high' ? 'red' : task.priority === 'medium' ? 'yellow' : 'green'}-600/20 text-${task.priority === 'high' ? 'red' : task.priority === 'medium' ? 'yellow' : 'green'}-400 px-2 py-1 rounded">${task.priority}</span>
                                                        <div class="flex space-x-1">
                                                            <button data-action="update-task-status" data-task-id="${task.id}" data-status="todo" class="text-gray-400 hover:text-gray-300 p-1" title="TODO„Å´Êàª„Åô">‚Üê</button>
                                                            <button data-action="update-task-status" data-task-id="${task.id}" data-status="done" class="text-green-400 hover:text-green-300 p-1" title="ÂÆå‰∫Ü">‚úì</button>
                                                            <button onclick="deleteTask('${task.id}')" class="text-red-400 hover:text-red-300 p-1" title="ÂâäÈô§">√ó</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                    <div class="space-y-4">
                                        <h3 class="font-semibold text-green-400 flex items-center">
                                            <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                                            ÂÆå‰∫Ü (${doneTasks.length})
                                        </h3>
                                        <div class="space-y-3">
                                            ${doneTasks.map(task => `
                                                <div class="task-card glass-effect p-4 cursor-pointer priority-${task.priority} opacity-75" data-task-id="${task.id}">
                                                    <h4 class="font-medium mb-2 line-through">${task.title}</h4>
                                                    <p class="text-sm text-gray-400 mb-3">${task.description}</p>
                                                    <div class="flex justify-between items-center text-xs">
                                                        <span class="bg-green-600/20 text-green-400 px-2 py-1 rounded">ÂÆå‰∫Ü</span>
                                                        <div class="flex space-x-1">
                                                            <button data-action="update-task-status" data-task-id="${task.id}" data-status="in-progress" class="text-blue-400 hover:text-blue-300 p-1" title="ÈÄ≤Ë°å‰∏≠„Å´Êàª„Åô">‚Ü∂</button>
                                                            <button onclick="deleteTask('${task.id}')" class="text-red-400 hover:text-red-300 p-1" title="ÂâäÈô§">√ó</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                }

                else if (feature.type === 'wiki') {
                    const pages = content?.pages || {};
                    const activePageId = state.activeWikiPageId || Object.keys(pages)[0];
                    const activePage = pages[activePageId];
                    
                    if (!activePage && Object.keys(pages).length === 0) {
                        return `
                            <div class="h-full flex items-center justify-center">
                                <div class="text-center space-y-6">
                                    <i data-lucide="book-open" class="w-20 h-20 mx-auto text-gray-500"></i>
                                    <p class="text-2xl font-semibold">No Wiki Pages</p>
                                    <p class="text-gray-400 text-lg">Create your first knowledge base page</p>
                                    <button onclick="createNewWikiPage()" class="btn mt-4">
                                        <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                                        Create First Page
                                    </button>
                                </div>
                            </div>`;
                    }

                    const currentPage = activePage || Object.values(pages)[0];
                    
                    return `
                        <div class="h-full flex flex-col bg-gradient-to-br from-purple-900/20 to-blue-900/20">
                            <div class="border-b border-white/10 p-6 glass-effect">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h1 class="text-3xl font-bold text-white mb-2" ${state.isEditingWiki ? 'contenteditable="true" id="wiki-title-edit"' : ''}>${currentPage.title}</h1>
                                        <div class="flex items-center space-x-4 text-sm text-gray-400">
                                            <span>By ${currentPage.author}</span>
                                            <span>‚Ä¢</span>
                                            <span>${new Date(currentPage.created_at * 1000).toLocaleDateString()}</span>
                                            <span>‚Ä¢</span>
                                            <div class="flex space-x-2">
                                                ${(currentPage.tags || []).map(tag => `<span class="bg-blue-600/30 px-2 py-1 rounded text-xs">#${tag}</span>`).join('')}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex space-x-3">
                                        ${state.isEditingWiki ? `
                                            <button onclick="saveWikiPage()" class="btn">
                                                <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                                                Save
                                            </button>
                                            <button onclick="cancelWikiEdit()" class="btn-secondary">
                                                <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                                                Cancel
                                            </button>
                                        ` : `
                                            <button onclick="editWikiPage()" class="btn">
                                                <i data-lucide="edit-3" class="w-4 h-4 mr-2"></i>
                                                Edit
                                            </button>
                                        `}
                                        <button onclick="createNewWikiPage()" class="btn">
                                            <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                                            Êñ∞Ë¶è„Éö„Éº„Ç∏
                                        </button>
                                        <button onclick="deleteWikiPage('${activePageId}')" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg text-white transition-all">
                                            <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>
                                            ÂâäÈô§
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex-1 flex overflow-hidden">
                                <div class="flex-1 p-6 overflow-y-auto">
                                    <div class="prose prose-invert max-w-none">
                                        ${state.isEditingWiki ? `
                                            <textarea id="wiki-content-edit" class="w-full h-96 bg-black/20 border border-white/20 rounded-lg p-4 text-white resize-none" placeholder="Write your content here...">${currentPage.content}</textarea>
                                        ` : `
                                            <div class="text-gray-200 leading-relaxed whitespace-pre-wrap">${currentPage.content}</div>
                                        `}
                                    </div>
                                </div>
                            </div>
                        </div>`;
                }
                
                else if (feature.type === 'calendar') {
                    const events = content?.events || {};
                    const displayDate = state.calendarDate || new Date();
                    const monthNames = ['1Êúà', '2Êúà', '3Êúà', '4Êúà', '5Êúà', '6Êúà', '7Êúà', '8Êúà', '9Êúà', '10Êúà', '11Êúà', '12Êúà'];
                    const dayNames = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
                    
                    // „Ç´„É¨„É≥„ÉÄ„Éº„ÅÆÊó•‰ªòË®àÁÆó
                    const year = displayDate.getFullYear();
                    const month = displayDate.getMonth();
                    const firstDay = new Date(year, month, 1);
                    const lastDay = new Date(year, month + 1, 0);
                    const startDate = new Date(firstDay);
                    startDate.setDate(firstDay.getDate() - firstDay.getDay());
                    
                    const calendarDays = [];
                    for (let i = 0; i < 42; i++) {
                        const date = new Date(startDate);
                        date.setDate(startDate.getDate() + i);
                        calendarDays.push(date);
                    }
                    
                    return `
                        <div class="h-full flex flex-col bg-gradient-to-br from-green-900/20 to-blue-900/20">
                            <div class="border-b border-white/10 p-6 glass-effect">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h1 class="text-3xl font-bold text-white mb-2">${year}Âπ¥ ${monthNames[month]}</h1>
                                        <p class="text-gray-300">„Ç§„Éô„É≥„Éà„Ç´„É¨„É≥„ÉÄ„Éº & „Çπ„Ç±„Ç∏„É•„Éº„É™„É≥„Ç∞</p>
                                    </div>
                                    <div class="flex space-x-3">
                                        <button data-action="calendar-prev" class="p-3 rounded-lg glass-effect hover:bg-white/10 transition-all">
                                            <i data-lucide="chevron-left" class="w-5 h-5"></i>
                                        </button>
                                        <button data-action="create-event" class="btn">
                                            <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                                            „Ç§„Éô„É≥„ÉàËøΩÂä†
                                        </button>
                                        <button data-action="calendar-next" class="p-3 rounded-lg glass-effect hover:bg-white/10 transition-all">
                                            <i data-lucide="chevron-right" class="w-5 h-5"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="flex-1 p-8">
                                <div class="grid grid-cols-7 gap-2 mb-4">
                                    ${dayNames.map(day => `
                                        <div class="text-center font-semibold text-gray-400 py-4">${day}</div>
                                    `).join('')}
                                </div>
                                <div class="grid grid-cols-7 gap-2 h-96">
                                    ${calendarDays.map(date => {
                                        const dateStr = date.toISOString().split('T')[0];
                                        const dayEvents = Object.values(events).filter(event => event.date === dateStr);
                                        const isCurrentMonth = date.getMonth() === month;
                                        const isToday = date.toDateString() === new Date().toDateString();
                                        
                                        return `
                                            <div class="border border-white/10 rounded-lg p-2 min-h-24 ${
                                                isToday ? 'bg-blue-600/30 border-blue-400' : 
                                                dayEvents.length > 0 ? 'bg-green-600/20 border-green-400/50' : 
                                                'glass-effect'
                                            } hover:bg-white/10 cursor-pointer transition-all ${!isCurrentMonth ? 'opacity-50' : ''}">
                                                <div class="font-semibold text-sm mb-1 ${isToday ? 'text-blue-300' : ''}">${date.getDate()}</div>
                                                ${dayEvents.map(event => `
                                                    <div class="calendar-event bg-blue-600 text-white text-xs mb-1 p-1 rounded truncate" title="${event.title}">
                                                        ${event.title}
                                                    </div>
                                                `).join('')}
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>`;
                }
                else if (feature.type === 'budget') {
                    const accounts = content?.accounts || {};
                    const transactions = content?.transactions || {};
                    const totalBalance = Object.values(accounts).reduce((sum, acc) => sum + (acc.balance || 0), 0);
                    
                    return `
                        <div class="h-full bg-gradient-to-br from-emerald-900/30 to-green-700/20">
                            <div class="p-6">
                                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
                                    <!-- Á∑èÊÆãÈ´ò„Ç´„Éº„Éâ -->
                                    <div class="lg:col-span-1 bg-gradient-to-r from-green-600 to-emerald-600 rounded-2xl p-6 text-white shadow-lg">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <p class="text-green-100 text-sm">Á∑èÊÆãÈ´ò</p>
                                                <p class="text-3xl font-bold">¬•${totalBalance.toLocaleString()}</p>
                                            </div>
                                            <i data-lucide="wallet" class="w-12 h-12 text-green-200"></i>
                                        </div>
                                    </div>
                                    
                                    <!-- ÂèéÂÖ•„Ç´„Éº„Éâ -->
                                    <div class="bg-gradient-to-r from-blue-600 to-cyan-600 rounded-2xl p-6 text-white shadow-lg">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <p class="text-blue-100 text-sm">‰ªäÊúà„ÅÆÂèéÂÖ•</p>
                                                <p class="text-2xl font-bold">¬•${Object.values(transactions).filter(t => t.amount > 0).reduce((sum, t) => sum + t.amount, 0).toLocaleString()}</p>
                                            </div>
                                            <i data-lucide="trending-up" class="w-10 h-10 text-blue-200"></i>
                                        </div>
                                    </div>
                                    
                                    <!-- ÊîØÂá∫„Ç´„Éº„Éâ -->
                                    <div class="bg-gradient-to-r from-red-600 to-pink-600 rounded-2xl p-6 text-white shadow-lg">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <p class="text-red-100 text-sm">‰ªäÊúà„ÅÆÊîØÂá∫</p>
                                                <p class="text-2xl font-bold">¬•${Math.abs(Object.values(transactions).filter(t => t.amount < 0).reduce((sum, t) => sum + t.amount, 0)).toLocaleString()}</p>
                                            </div>
                                            <i data-lucide="trending-down" class="w-10 h-10 text-red-200"></i>
                                        </div>
                                    </div>
                                    
                                    <!-- „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ -->
                                    <div class="flex flex-col space-y-3">
                                        <button data-action="add-transaction" class="bg-white/10 hover:bg-white/20 backdrop-blur-sm border border-white/20 rounded-xl p-4 text-white font-medium transition-all">
                                            <i data-lucide="plus" class="w-5 h-5 mr-2 inline"></i>
                                            ÂèñÂºïËøΩÂä†
                                        </button>
                                        <button data-action="create-account" class="bg-white/10 hover:bg-white/20 backdrop-blur-sm border border-white/20 rounded-xl p-4 text-white font-medium transition-all">
                                            <i data-lucide="credit-card" class="w-5 h-5 mr-2 inline"></i>
                                            Âè£Â∫ßËøΩÂä†
                                        </button>
                                    </div>
                                </div>
                            <div class="flex-1 p-8 overflow-y-auto">
                                <div class="space-y-6">
                                    <div class="flex justify-between items-center">
                                        <h3 class="text-xl font-semibold text-white">Âè£Â∫ß‰∏ÄË¶ß</h3>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        ${Object.values(accounts).map(account => `
                                            <div class="budget-card relative group">
                                                <button onclick="deleteAccount('${account.id}')" class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity text-red-400 hover:text-red-300 w-6 h-6 flex items-center justify-center" title="Âè£Â∫ßÂâäÈô§">√ó</button>
                                                <div class="flex justify-between items-center">
                                                    <div>
                                                        <h4 class="text-lg font-semibold text-white">${account.name}</h4>
                                                        <p class="text-gray-400 capitalize">${account.type === 'checking' ? 'ÊôÆÈÄöÈ†êÈáë' : account.type === 'savings' ? 'ÂÆöÊúüÈ†êÈáë' : 'ÁèæÈáë'}</p>
                                                    </div>
                                                    <div class="text-right">
                                                        <p class="text-2xl font-bold ${account.balance >= 0 ? 'text-green-400' : 'text-red-400'}">
                                                            $${account.balance.toFixed(2)}
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                    <div class="mt-8">
                                        <div class="flex justify-between items-center mb-4">
                                            <h3 class="text-xl font-semibold text-white">ÊúÄËøë„ÅÆÂèñÂºï</h3>
                                        </div>
                                        <div class="space-y-3 max-h-64 overflow-y-auto">
                                            ${Object.values(transactions).slice(-10).reverse().map(transaction => `
                                                <div class="glass-effect p-4 rounded-lg group relative">
                                                    <button onclick="deleteTransaction('${transaction.id}')" class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity text-red-400 hover:text-red-300 w-6 h-6 flex items-center justify-center" title="ÂèñÂºïÂâäÈô§">√ó</button>
                                                    <div class="flex justify-between items-center">
                                                        <div>
                                                            <p class="font-medium text-white">${transaction.description}</p>
                                                            <p class="text-sm text-gray-400">${transaction.category || '„Åù„ÅÆ‰ªñ'}</p>
                                                        </div>
                                                        <p class="font-semibold ${transaction.amount >= 0 ? 'text-green-400' : 'text-red-400'}">
                                                            ${transaction.amount >= 0 ? '+' : ''}¬•${Math.abs(transaction.amount).toLocaleString()}
                                                        </p>
                                                    </div>
                                                </div>
                                            `).join('') || '<p class="text-gray-400 text-center py-8">ÂèñÂºïÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                }
                else if (feature.type === 'inventory') {
                    const items = content?.items || {};
                    const categories = Object.values(items).reduce((cats, item) => {
                        if (item.category && !cats.includes(item.category)) cats.push(item.category);
                        return cats;
                    }, ['ÈõªÂ≠êÊ©üÂô®', 'ÊñáÊàøÂÖ∑', 'Êõ∏Á±ç', 'ÂÆ∂ÂÖ∑', '„Åù„ÅÆ‰ªñ']);
                    const locations = Object.values(items).reduce((locs, item) => {
                        if (item.location && !locs.includes(item.location)) locs.push(item.location);
                        return locs;
                    }, ['Êú¨Á§æ', 'ÂÄâÂ∫´', '‰ºöË≠∞ÂÆ§', '„Åù„ÅÆ‰ªñ']);
                    
                    const lowStockItems = Object.values(items).filter(item => (item.quantity || 0) < (item.minStock || 5));
                    const totalValue = Object.values(items).reduce((sum, item) => sum + ((item.quantity || 0) * (item.unitPrice || 0)), 0);
                    
                    return `
                        <div class="h-full bg-gradient-to-br from-orange-900/30 to-amber-700/20">
                            <div class="p-6">
                                <!-- „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Ç´„Éº„Éâ -->
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                                    <div class="bg-gradient-to-r from-orange-600 to-red-600 rounded-2xl p-6 text-white shadow-lg">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <p class="text-orange-100 text-sm">Á∑è„Ç¢„Ç§„ÉÜ„É†Êï∞</p>
                                                <p class="text-3xl font-bold">${Object.keys(items).length}</p>
                                            </div>
                                            <i data-lucide="package" class="w-12 h-12 text-orange-200"></i>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-gradient-to-r from-yellow-600 to-orange-600 rounded-2xl p-6 text-white shadow-lg">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <p class="text-yellow-100 text-sm">Âú®Â∫´Âàá„ÇåË≠¶Âëä</p>
                                                <p class="text-3xl font-bold text-yellow-200">${lowStockItems.length}</p>
                                            </div>
                                            <i data-lucide="alert-triangle" class="w-12 h-12 text-yellow-200"></i>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-gradient-to-r from-green-600 to-emerald-600 rounded-2xl p-6 text-white shadow-lg">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <p class="text-green-100 text-sm">Á∑èË≥áÁî£‰æ°ÂÄ§</p>
                                                <p class="text-2xl font-bold">¬•${totalValue.toLocaleString()}</p>
                                            </div>
                                            <i data-lucide="yen-sign" class="w-12 h-12 text-green-200"></i>
                                        </div>
                                    </div>
                                    
                                    <div class="flex flex-col space-y-3">
                                        <button data-action="add-inventory-item" class="bg-white/10 hover:bg-white/20 backdrop-blur-sm border border-white/20 rounded-xl p-4 text-white font-medium transition-all">
                                            <i data-lucide="plus" class="w-5 h-5 mr-2 inline"></i>
                                            „Ç¢„Ç§„ÉÜ„É†ËøΩÂä†
                                        </button>
                                        <button onclick="exportInventory()" class="bg-white/10 hover:bg-white/20 backdrop-blur-sm border border-white/20 rounded-xl p-4 text-white font-medium transition-all">
                                            <i data-lucide="download" class="w-5 h-5 mr-2 inline"></i>
                                            „Ç®„ÇØ„Çπ„Éù„Éº„Éà
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- „Éï„Ç£„É´„Çø„Éº„Å®Ê§úÁ¥¢ -->
                                <div class="bg-white/5 backdrop-blur-sm rounded-2xl p-6 mb-6">
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                        <input type="text" placeholder="„Ç¢„Ç§„ÉÜ„É†Ê§úÁ¥¢..." class="bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-gray-400 focus:border-orange-400 focus:outline-none">
                                        <select class="bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white focus:border-orange-400 focus:outline-none">
                                            <option value="">„Åô„Åπ„Å¶„ÅÆ„Ç´„ÉÜ„Ç¥„É™</option>
                                            ${categories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                                        </select>
                                        <select class="bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white focus:border-orange-400 focus:outline-none">
                                            <option value="">„Åô„Åπ„Å¶„ÅÆÂ†¥ÊâÄ</option>
                                            ${locations.map(loc => `<option value="${loc}">${loc}</option>`).join('')}
                                        </select>
                                        <select class="bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white focus:border-orange-400 focus:outline-none">
                                            <option value="">„Åô„Åπ„Å¶„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ</option>
                                            <option value="available">Âà©Áî®ÂèØËÉΩ</option>
                                            <option value="low-stock">Âú®Â∫´Â∞ë</option>
                                            <option value="out-of-stock">Âú®Â∫´Âàá„Çå</option>
                                        </select>
                                    </div>
                                </div>
                            <div class="flex-1 p-8 overflow-y-auto">
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    ${Object.values(items).map(item => `
                                        <div class="inventory-item hover:shadow-lg transition-all cursor-pointer group relative" data-item-id="${item.id}">
                                            <button onclick="deleteInventoryItem('${item.id}')" class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity text-red-400 hover:text-red-300 w-6 h-6 flex items-center justify-center z-10" title="„Ç¢„Ç§„ÉÜ„É†ÂâäÈô§">√ó</button>
                                            <div class="flex justify-between items-start mb-3">
                                                <div>
                                                    <h4 class="text-lg font-semibold text-white">${item.name}</h4>
                                                    <p class="text-sm text-gray-400">${item.category || '„Åù„ÅÆ‰ªñ'}</p>
                                                </div>
                                                <span class="bg-orange-600/30 px-2 py-1 rounded text-xs text-orange-300">${item.quantity || 0}</span>
                                            </div>
                                            <div class="space-y-2">
                                                <div class="flex justify-between text-sm">
                                                    <span class="text-gray-400">Location:</span>
                                                    <span class="text-white">${item.location}</span>
                                                </div>
                                                <div class="flex justify-between text-sm">
                                                    <span class="text-gray-400">Status:</span>
                                                    <span class="text-green-400">${item.status || 'Available'}</span>
                                                </div>
                                                ${item.value ? `
                                                    <div class="flex justify-between text-sm">
                                                        <span class="text-gray-400">Value:</span>
                                                        <span class="text-white">$${item.value}</span>
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    `).join('') || '<div class="col-span-full text-center text-gray-400 py-12">No inventory items yet</div>'}
                                </div>
                            </div>
                        </div>`;
                }
                else if (feature.type === 'members') {
                    // „Çµ„Éº„Éê„Éº„ÅÆÂÆüÈöõ„ÅÆ„É°„É≥„Éê„ÉºÊÉÖÂ†±„ÇíË°®Á§∫
                    const currentServer = state.servers[state.activeServerId];
                    const serverMembers = state.serverMembers?.[state.activeServerId] || [];
                    
                    return `
                        <div class="h-full flex flex-col bg-gradient-to-br from-indigo-900/20 to-purple-900/20">
                            <div class="border-b border-white/10 p-6 glass-effect">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h1 class="text-3xl font-bold text-white mb-2">„É°„É≥„Éê„ÉºÁÆ°ÁêÜ</h1>
                                        <p class="text-gray-300">${currentServer?.name || '„Çµ„Éº„Éê„Éº'} - ${serverMembers.length} ‰∫∫„ÅÆ„É°„É≥„Éê„Éº</p>
                                    </div>
                                    <div class="flex space-x-3">
                                        <button data-action="createInvite" class="gradient-button px-4 py-2 rounded-lg font-medium">
                                            <i data-lucide="user-plus" class="w-4 h-4 mr-2"></i>
                                            ÊãõÂæÖ„Ç≥„Éº„Éâ‰ΩúÊàê
                                        </button>
                                        <button data-action="joinServer" class="btn-secondary px-4 py-2 rounded-lg">
                                            <i data-lucide="log-in" class="w-4 h-4 mr-2"></i>
                                            „Çµ„Éº„Éê„ÉºÂèÇÂä†
                                        </button>
                                        <button onclick="loadServerMembers()" class="btn-secondary px-4 py-2 rounded-lg">
                                            <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>
                                            Êõ¥Êñ∞
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="flex-1 p-8 overflow-y-auto">
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    ${serverMembers.length > 0 ? serverMembers.map(member => `
                                        <div class="member-card hover:shadow-xl transition-all cursor-pointer" data-member-id="${member.id}">
                                            <div class="flex items-start space-x-4">
                                                <div class="w-16 h-16 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 flex items-center justify-center text-white font-bold text-xl overflow-hidden">
                                                    ${member.avatar ? `<img src="${member.avatar}" alt="${member.nickname}" class="w-full h-full object-cover">` : (member.nickname || member.username)[0].toUpperCase()}
                                                </div>
                                                <div class="flex-1">
                                                    <h4 class="text-lg font-semibold text-white">${member.nickname || member.username}</h4>
                                                    <p class="text-sm text-gray-400 mb-1">@${member.username}</p>
                                                    <p class="text-sm text-gray-300 mb-2">${member.role === 'owner' ? '„Ç™„Éº„Éä„Éº' : member.role === 'admin' ? 'ÁÆ°ÁêÜËÄÖ' : member.role === 'moderator' ? '„É¢„Éá„É¨„Éº„Çø„Éº' : '„É°„É≥„Éê„Éº'}</p>
                                                    <div class="flex items-center space-x-2">
                                                        <span class="w-2 h-2 bg-green-400 rounded-full"></span>
                                                        <span class="text-xs text-gray-400">ÂèÇÂä†Êó•: ${new Date(member.joinedAt).toLocaleDateString('ja-JP')}</span>
                                                    </div>
                                                    ${state.currentUser && (currentServer?.userRole === 'owner' || currentServer?.userRole === 'admin') && member.username !== state.currentUser.username ? `
                                                        <div class="mt-3 flex space-x-2">
                                                            <select onchange="updateMemberRole('${member.id}', this.value)" class="text-xs bg-white/10 border border-white/20 rounded px-2 py-1 flex-1">
                                                                <option value="member" ${member.role === 'member' ? 'selected' : ''}>„É°„É≥„Éê„Éº</option>
                                                                <option value="moderator" ${member.role === 'moderator' ? 'selected' : ''}>„É¢„Éá„É¨„Éº„Çø„Éº</option>
                                                                ${currentServer?.userRole === 'owner' ? `<option value="admin" ${member.role === 'admin' ? 'selected' : ''}>ÁÆ°ÁêÜËÄÖ</option>` : ''}
                                                            </select>
                                                            <button onclick="kickMember('${member.id}')" class="text-xs bg-red-600/20 text-red-400 hover:bg-red-600/30 px-2 py-1 rounded transition-colors" title="„É°„É≥„Éê„Éº„Çí„Ç≠„ÉÉ„ÇØ">
                                                                „Ç≠„ÉÉ„ÇØ
                                                            </button>
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        </div>
                                    `).join('') : '<div class="col-span-full text-center text-gray-400 py-12">„É°„É≥„Éê„ÉºÊÉÖÂ†±„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>'}
                                </div>
                            </div>
            </div>`;
        }
                else if (feature.type === 'album') {
                    const albums = content?.albums || {};
                    const activeAlbumId = state.activeAlbumId || Object.keys(albums)[0];
                    const activeAlbum = albums[activeAlbumId];
                    
                    if (!activeAlbum && Object.keys(albums).length === 0) {
                        return `
                            <div class="h-full flex items-center justify-center bg-gradient-to-br from-pink-900/20 to-purple-900/20">
                                <div class="text-center space-y-6">
                                    <i data-lucide="image" class="w-20 h-20 mx-auto text-gray-500"></i>
                                    <p class="text-2xl font-semibold text-white">„Éï„Ç©„Éà„Ç¢„É´„Éê„É†„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                                    <p class="text-gray-400 text-lg">ÊúÄÂàù„ÅÆ„Éï„Ç©„Éà„Ç¢„É´„Éê„É†„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                                    <button data-action="create-album" class="btn mt-4">
                                        <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                                        „Ç¢„É´„Éê„É†‰ΩúÊàê
                                    </button>
                                </div>
                            </div>`;
                    }
                    
                    return `
                        <div class="h-full flex flex-col bg-gradient-to-br from-pink-900/20 to-purple-900/20">
                            <div class="border-b border-white/10 p-6 glass-effect">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h1 class="text-3xl font-bold text-white mb-2">${activeAlbum.title}</h1>
                                        <p class="text-gray-300">${activeAlbum.description} ‚Ä¢ ${activeAlbum.photos?.length || 0} photos</p>
                                    </div>
                                    <div class="flex space-x-3">
                                        <button data-action="upload-photos" class="gradient-button">
                                            <i data-lucide="upload" class="w-4 h-4 mr-2"></i>
                                            Upload Photos
                                        </button>
                                        <button data-action="create-album" class="bg-pink-600 hover:bg-pink-700 px-4 py-2 rounded-lg font-medium transition-all">
                                            <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                                            New Album
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="flex-1 p-8 overflow-y-auto">
                                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-4">
                                    ${(activeAlbum.photos || []).map((photo, index) => `
                                        <div class="album-photo bg-gray-800 aspect-square flex items-center justify-center cursor-pointer group relative" data-photo-index="${index}">
                                            <button onclick="deletePhoto('${activeAlbumId}', ${index})" class="absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity text-red-400 hover:text-red-300 w-6 h-6 flex items-center justify-center bg-black/50 rounded z-10" title="ÂÜôÁúüÂâäÈô§">√ó</button>
                                            <i data-lucide="image" class="w-8 h-8 text-gray-500"></i>
                                            <div class="absolute inset-0 bg-black/50 opacity-0 hover:opacity-100 transition-opacity flex items-center justify-center">
                                                <div class="text-white text-center">
                                                    <i data-lucide="eye" class="w-6 h-6 mx-auto mb-1"></i>
                                                    <p class="text-xs">Ë°®Á§∫</p>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('') || '<div class="col-span-full text-center text-gray-400 py-12">„Åì„ÅÆ„Ç¢„É´„Éê„É†„Å´„ÅØ„Åæ„Å†ÂÜôÁúü„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>'}
                                </div>
                            </div>
                        </div>`;
                }
                else if (feature.type === 'diary') {
                    const entries = content?.entries || {};
                    const sortedEntries = Object.values(entries).sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    
                    if (Object.keys(entries).length === 0) {
                        return `
                            <div class="h-full flex items-center justify-center bg-gradient-to-br from-green-900/20 to-teal-900/20">
                                <div class="text-center space-y-6">
                                    <i data-lucide="book-open" class="w-20 h-20 mx-auto text-gray-500"></i>
                                    <p class="text-2xl font-semibold text-white">Êó•Ë®ò„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                                    <p class="text-gray-400 text-lg">ÊúÄÂàù„ÅÆÊó•Ë®ò„Ç®„É≥„Éà„É™„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                                    <button data-action="create-diary-entry" class="btn mt-4">
                                        <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                                        Êó•Ë®ò„ÇíÊõ∏„Åè
                                    </button>
                                </div>
                            </div>`;
                    }
                    
                    return `
                        <div class="h-full flex flex-col bg-gradient-to-br from-green-900/20 to-teal-900/20">
                            <div class="border-b border-white/10 p-6 glass-effect">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h1 class="text-3xl font-bold text-white mb-2">ÂÖ±ÊúâÊó•Ë®ò</h1>
                                        <p class="text-gray-300">ÊÄù„ÅÑÂá∫„Å®‰ΩìÈ®ì„ÇíÂÖ±Êúâ ‚Ä¢ ${Object.keys(entries).length} „Ç®„É≥„Éà„É™</p>
                                    </div>
                                    <button data-action="create-diary-entry" class="gradient-button">
                                        <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                                        Êó•Ë®ò„ÇíÊõ∏„Åè
                                    </button>
                                </div>
                            </div>
                            <div class="flex-1 p-8 overflow-y-auto">
                                <div class="max-w-4xl mx-auto space-y-6">
                                    ${sortedEntries.map(entry => `
                                        <div class="diary-entry hover:shadow-xl transition-all group relative">
                                            <button onclick="deleteDiaryEntry('${entry.id}')" class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity text-red-400 hover:text-red-300 w-6 h-6 flex items-center justify-center" title="Êó•Ë®òÂâäÈô§">√ó</button>
                                            <div class="flex justify-between items-start mb-4">
                                                <div>
                                                    <h3 class="text-xl font-semibold text-white mb-1">${entry.title}</h3>
                                                    <div class="flex items-center space-x-3 text-sm text-gray-400">
                                                        <span>ÊäïÁ®øËÄÖ: ${entry.author}</span>
                                                        <span>‚Ä¢</span>
                                                        <span>${new Date(entry.created_at * 1000).toLocaleDateString('ja-JP')}</span>
                                                        ${entry.mood ? `<span>‚Ä¢</span><span class="bg-yellow-600/30 px-2 py-1 rounded">${entry.mood}</span>` : ''}
                                                    </div>
                                                </div>
                                                ${entry.private ? '<i data-lucide="lock" class="w-5 h-5 text-yellow-400" title="„Éó„É©„Ç§„Éô„Éº„Éà"></i>' : ''}
                                            </div>
                                            <div class="prose prose-invert max-w-none">
                                                ${entry.content.replace(/\\n/g, '<br>')}
                                            </div>
                                            ${entry.tags ? `
                                                <div class="flex space-x-2 mt-4">
                                                    ${entry.tags.map(tag => `<span class="bg-teal-600/30 px-2 py-1 rounded text-xs">#${tag}</span>`).join('')}
                                                </div>
                                            ` : ''}
                                        </div>
                                    `).join('') || '<div class="text-center text-gray-400 py-12">No diary entries yet. Start sharing your memories!</div>'}
                                </div>
                            </div>
                        </div>`;
                }

                return `
                    <div class="h-full flex items-center justify-center">
                        <div class="text-center space-y-6">
                            <i data-lucide="${feature.icon}" class="w-20 h-20 mx-auto text-gray-500"></i>
                            <p class="text-2xl font-semibold">${feature.name}</p>
                            <p class="text-gray-400 text-lg">Feature under development</p>
                        </div>
                    </div>`;
            }
        };
        
        // === „É¨„É≥„ÉÄ„É™„É≥„Ç∞Èñ¢Êï∞ ===
        const render = () => {
            try {
                console.log('Render called, state:', state);
                const appEl = document.getElementById('app');
                if (!state.currentUser) { 
                    appEl.classList.add('hidden'); 
                    return; 
                }
                
                // Force app visible and ensure it stays visible
                appEl.classList.remove('hidden');
                appEl.style.display = '';
                
                const serverBarEl = document.getElementById('server-bar');
                const headerEl = document.getElementById('header');
                const dockEl = document.getElementById('feature-dock');
                const subNavEl = document.getElementById('sub-nav');
                const contentEl = document.getElementById('content-display');
            
            // „Çµ„Éº„Éê„Éº„Çµ„Ç§„Éâ„Éê„Éº
            serverBarEl.innerHTML = `
                <div data-server-id="user-hub" class="server-icon w-16 h-16 mb-4 flex items-center justify-center glass-effect rounded-2xl cursor-pointer transition-all ${state.activeServerId === 'user-hub' ? 'active' : ''}">
                    <i data-lucide="home" class="w-8 h-8 text-blue-400"></i>
                </div>
                <div class="w-10 border-t border-white/20 my-4"></div>
                ${Object.values(state.servers).map(s => `
                    <div data-server-id="${s.id}" class="server-icon w-16 h-16 flex items-center justify-center glass-effect rounded-2xl cursor-pointer text-2xl transition-all ${state.activeServerId === s.id ? 'active' : ''}" title="${s.name}">
                        ${s.icon}
                    </div>
                `).join('')}
                <button data-action="add-server" class="mt-4 w-14 h-14 flex items-center justify-center glass-effect rounded-full text-green-400 hover:bg-green-400 hover:text-white transition-all">
                    <i data-lucide="plus" class="w-6 h-6"></i>
                </button>`;
            
            // „É¶„Éº„Ç∂„Éº„Éè„ÉñË°®Á§∫
            if(state.activeServerId === 'user-hub') { 
                headerEl.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-cyan-400 bg-clip-text text-transparent">„Éû„Ç§„Éè„Éñ</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm bg-white/10 px-3 py-1 rounded-full">${state.currentUser.username}</span>
                        <button data-action="logout" class="text-sm text-red-400 hover:text-red-300 transition-colors">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
                    </div>`;
                dockEl.classList.add('hidden'); 
                subNavEl.classList.add('hidden'); 
                contentEl.innerHTML = TEMPLATES.userHub(state); 
                lucide.createIcons(); 
                return; 
            }

            dockEl.classList.remove('hidden');
            subNavEl.classList.remove('hidden');

            const server = state.servers[state.activeServerId];
            if(!server && state.activeServerId !== 'user-hub') { 
                // Only default to user-hub if no valid server is selected
                if (!Object.keys(state.servers).length) {
                    state.activeServerId = 'user-hub'; 
                } else {
                    // Use the first available server instead
                    state.activeServerId = Object.keys(state.servers)[0];
                }
                render(); 
                return; 
            }
            
            const features = state.features[state.activeServerId] || [];
            
            // „Éò„ÉÉ„ÉÄ„Éº
            headerEl.innerHTML = `
                <div class="flex items-center space-x-4">
                    <div class="text-2xl">${server.icon}</div>
                    <h1 class="text-2xl font-bold">${server.name}</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm bg-white/10 px-3 py-1 rounded-full">${state.currentUser.username}</span>
                    <button data-action="logout" class="text-sm text-red-400 hover:text-red-300 transition-colors">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
                </div>`;
            
            // Ê©üËÉΩ„Éâ„ÉÉ„ÇØ
            dockEl.innerHTML = features.map(f => `
                <a href="#" data-feature-id="${f.id}" class="dock-item h-full flex items-center px-8 py-3 space-x-4 rounded-lg transition-all ${f.id === state.activeFeatureId ? 'active' : ''}">
                    <i data-lucide="${f.icon}" class="w-6 h-6"></i>
                    <span class="font-semibold">${f.name}</span>
                </a>
            `).join('');
            
            const activeFeature = features.find(f => f.id === state.activeFeatureId);
            if(!activeFeature) { 
                subNavEl.classList.add('hidden'); 
                contentEl.innerHTML = ''; 
                return;
            }
            
            const featureContentData = state.content[activeFeature.id];

            // „Çµ„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥
            subNavEl.innerHTML = TEMPLATES.sub_nav(activeFeature, featureContentData, state);
            
            // „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ
            let activeSubItem = null;
            if (activeFeature.type === 'chat' || activeFeature.type === 'forum') {
                activeSubItem = state.activeSubItemId ? featureContentData?.subItems?.[state.activeSubItemId] : null;
            }
            
            contentEl.innerHTML = TEMPLATES.content(activeFeature, featureContentData, activeSubItem, state);
            
            // „Éõ„ÉØ„Ç§„Éà„Éú„Éº„ÉâÂàùÊúüÂåñ
            if (activeFeature.type === 'whiteboard' && featureContentData?.boards) {
                initializeWhiteboard(state.activeBoardId || Object.keys(featureContentData.boards)[0]);
            }
            
            lucide.createIcons();
            } catch (error) {
                console.error('Render error:', error);
                showNotification('Render error: ' + error.message, 'error');
                // Ensure app stays visible even on render error
                const appEl = document.getElementById('app');
                if (appEl && state.currentUser) {
                    appEl.classList.remove('hidden');
                    appEl.style.display = '';
                }
            }
        };

        // === „Ç∑„É≥„Éó„É´„Éõ„ÉØ„Ç§„Éà„Éú„Éº„ÉâÊ©üËÉΩ ===
        let isDrawing = false;
        let currentTool = 'pen';
        let whiteboardCanvas = null;
        let whiteboardCtx = null;
        let whiteboardHistory = [];
        let historyStep = 0;
        
        function initializeWhiteboard(boardId) {
            try {
                console.log('Initializing simple whiteboard for board:', boardId);
                
                // Âè§„ÅÑ„Ç≠„É£„É≥„Éê„Çπ„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
                if (whiteboardCanvas) {
                    whiteboardCanvas.removeEventListener('mousedown', startDrawing);
                    whiteboardCanvas.removeEventListener('mousemove', draw);
                    whiteboardCanvas.removeEventListener('mouseup', stopDrawing);
                }
                
                setTimeout(() => {
                    whiteboardCanvas = document.getElementById('simple-whiteboard');
                    if (!whiteboardCanvas) {
                        console.error('Simple whiteboard canvas not found');
                        return;
                    }
                    
                    whiteboardCtx = whiteboardCanvas.getContext('2d');
                    
                    // „Ç≠„É£„É≥„Éê„Çπ„Çµ„Ç§„Ç∫„ÇíË¶™Ë¶ÅÁ¥†„Å´Âêà„Çè„Åõ„Çã
                    const rect = whiteboardCanvas.parentElement.getBoundingClientRect();
                    whiteboardCanvas.width = rect.width;
                    whiteboardCanvas.height = rect.height;
                    
                    // ËÉåÊôØ„ÇíÁôΩ„Å´„Åô„Çã
                    whiteboardCtx.fillStyle = 'white';
                    whiteboardCtx.fillRect(0, 0, whiteboardCanvas.width, whiteboardCanvas.height);
                    
                    // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
                    whiteboardCanvas.addEventListener('mousedown', startDrawing);
                    whiteboardCanvas.addEventListener('mousemove', draw);
                    whiteboardCanvas.addEventListener('mouseup', stopDrawing);
                    whiteboardCanvas.addEventListener('mouseout', stopDrawing);
                    
                    // „ÉÑ„Éº„É´„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
                    document.querySelectorAll('.whiteboard-tool').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            document.querySelectorAll('.whiteboard-tool').forEach(b => {
                                b.classList.remove('active', 'bg-blue-600');
                                b.classList.add('bg-gray-600');
                            });
                            e.target.closest('.whiteboard-tool').classList.add('active', 'bg-blue-600');
                            e.target.closest('.whiteboard-tool').classList.remove('bg-gray-600');
                            currentTool = e.target.closest('.whiteboard-tool').dataset.tool;
                        });
                    });
                    
                    // Êó¢Â≠ò„ÅÆ„Éú„Éº„Éâ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø
                    loadWhiteboardData(boardId);
                    
                    // „Éö„É≥„Çµ„Ç§„Ç∫Ë°®Á§∫„ÅÆÊõ¥Êñ∞
                    const penSizeRange = document.getElementById('pen-size');
                    const penSizeDisplay = document.getElementById('pen-size-display');
                    if (penSizeRange && penSizeDisplay) {
                        penSizeRange.addEventListener('input', (e) => {
                            penSizeDisplay.textContent = e.target.value;
                        });
                    }
                    
                    // Â±•Ê≠¥„Çí‰øùÂ≠ò
                    saveToHistory();
                    
                    console.log('Simple whiteboard initialized successfully');
                }, 100);
                
            } catch (err) {
                console.error('Error initializing simple whiteboard:', err);
            }
        }
        
        function startDrawing(e) {
            if (currentTool === 'text') {
                addText(e);
                return;
            }
            
            isDrawing = true;
            const rect = whiteboardCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            whiteboardCtx.beginPath();
            whiteboardCtx.moveTo(x, y);
        }
        
        function draw(e) {
            if (!isDrawing) return;
            
            const rect = whiteboardCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const penColor = document.getElementById('pen-color')?.value || '#000000';
            const penSize = document.getElementById('pen-size')?.value || 3;
            
            whiteboardCtx.lineWidth = penSize;
            whiteboardCtx.lineCap = 'round';
            
            if (currentTool === 'pen') {
                whiteboardCtx.globalCompositeOperation = 'source-over';
                whiteboardCtx.strokeStyle = penColor;
            } else if (currentTool === 'eraser') {
                whiteboardCtx.globalCompositeOperation = 'destination-out';
            }
            
            whiteboardCtx.lineTo(x, y);
            whiteboardCtx.stroke();
        }
        
        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                saveToHistory();
                // ÊèèÁîªÁµÇ‰∫ÜÊôÇ„Å´Ëá™Âãï‰øùÂ≠ò
                setTimeout(saveWhiteboardImage, 1000);
            }
        }
        
        function addText(e) {
            const rect = whiteboardCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const text = prompt('„ÉÜ„Ç≠„Çπ„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:');
            if (text) {
                const penColor = document.getElementById('pen-color')?.value || '#000000';
                whiteboardCtx.fillStyle = penColor;
                whiteboardCtx.font = '16px Arial';
                whiteboardCtx.fillText(text, x, y);
                saveToHistory();
            }
        }
        
        function saveToHistory() {
            historyStep++;
            if (historyStep < whiteboardHistory.length) {
                whiteboardHistory.length = historyStep;
            }
            whiteboardHistory.push(whiteboardCanvas.toDataURL());
        }
        
        function clearWhiteboard() {
            if (confirm('„Éõ„ÉØ„Ç§„Éà„Éú„Éº„Éâ„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åô„ÅãÔºü')) {
                whiteboardCtx.fillStyle = 'white';
                whiteboardCtx.fillRect(0, 0, whiteboardCanvas.width, whiteboardCanvas.height);
                saveToHistory();
            }
        }
        
        function loadWhiteboardData(boardId) {
            if (!boardId || !state.activeFeatureId) return;
            
            const feature = state.features[state.activeServerId].find(f => f.id === state.activeFeatureId);
            const content = state.content[feature.id] || {};
            
            if (content.boards && content.boards[boardId] && content.boards[boardId].elements) {
                try {
                    const data = JSON.parse(content.boards[boardId].elements);
                    if (data.imageData && whiteboardCtx) {
                        const img = new Image();
                        img.onload = function() {
                            whiteboardCtx.drawImage(img, 0, 0);
                            saveToHistory();
                        };
                        img.src = data.imageData;
                    }
                } catch (error) {
                    console.error('Error loading whiteboard data:', error);
                }
            }
        }

        function saveWhiteboardImage() {
            if (!whiteboardCanvas || !state.activeBoardId) return;
            
            try {
                const imageData = whiteboardCanvas.toDataURL('image/png');
                
                // „Çµ„Éº„Éê„Éº„Å´‰øùÂ≠ò„Åó„ÄÅÂêåÊôÇ„Å´„É≠„Éº„Ç´„É´Áä∂ÊÖã„ÇÇÊõ¥Êñ∞
                apiCall('saveWhiteboard', {
                    featureId: state.activeFeatureId,
                    boardId: state.activeBoardId,
                    elements: JSON.stringify({ imageData: imageData })
                }).then(result => {
                    if (result) {
                        console.log('Simple whiteboard auto-saved');
                        // „É≠„Éº„Ç´„É´Áä∂ÊÖã„ÇíÊõ¥Êñ∞
                        if (state.content[state.activeFeatureId]) {
                            if (!state.content[state.activeFeatureId].boards) {
                                state.content[state.activeFeatureId].boards = {};
                            }
                            if (!state.content[state.activeFeatureId].boards[state.activeBoardId]) {
                                state.content[state.activeFeatureId].boards[state.activeBoardId] = {
                                    id: state.activeBoardId,
                                    name: '„Éõ„ÉØ„Ç§„Éà„Éú„Éº„Éâ'
                                };
                            }
                            state.content[state.activeFeatureId].boards[state.activeBoardId].elements = { imageData: imageData };
                            state.content[state.activeFeatureId].boards[state.activeBoardId].updated_at = Date.now();
                        }
                    }
                }).catch(error => {
                    console.error('Error auto-saving whiteboard:', error);
                });
                
            } catch (error) {
                console.error('Error saving whiteboard image:', error);
            }
        }

        function exportWhiteboard() {
            const link = document.createElement('a');
            link.download = `whiteboard_${new Date().toISOString().slice(0,10)}.png`;
            link.href = whiteboardCanvas.toDataURL();
            link.click();
            showNotification('„Éõ„ÉØ„Ç§„Éà„Éú„Éº„Éâ„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Åæ„Åó„Åü', 'success');
        }
        
        async function saveWhiteboard() {
            if (!whiteboardCanvas) return;
            
            try {
                const imageData = whiteboardCanvas.toDataURL('image/png');
                const result = await apiCall('saveWhiteboardImage', {
                    featureId: state.activeFeatureId,
                    boardId: state.activeBoardId,
                    imageData: imageData
                });
                
                if (result) {
                    showNotification('„Éõ„ÉØ„Ç§„Éà„Éú„Éº„Éâ„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü', 'success');
                } else {
                    showNotification('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                }
            } catch (error) {
                console.error('Whiteboard save error:', error);
                showNotification('‰øùÂ≠ò„Ç®„É©„Éº: ' + error.message, 'error');
            }
        }

        function saveWhiteboardData() {
            if (currentWhiteboardCanvas && state.activeBoardId) {
                try {
                    const data = currentWhiteboardCanvas.toJSON();
                    
                    // Save to server immediately
                    apiCall('saveWhiteboard', {
                        featureId: state.activeFeatureId,
                        boardId: state.activeBoardId,
                        elements: JSON.stringify(data)
                    }).then(result => {
                        if (result) {
                            console.log('Fabric whiteboard data saved to server');
                            // Update local state
                            if (state.content[state.activeFeatureId]) {
                                if (!state.content[state.activeFeatureId].boards) {
                                    state.content[state.activeFeatureId].boards = {};
                                }
                                if (state.content[state.activeFeatureId].boards[state.activeBoardId]) {
                                    state.content[state.activeFeatureId].boards[state.activeBoardId].elements = data;
                                }
                            }
                        }
                    }).catch(error => {
                        console.error('Error saving whiteboard to server:', error);
                    });
                } catch (error) {
                    console.error('Error saving whiteboard:', error);
                }
            }
        }

        function setupWhiteboardTools() {
            // Tool buttons
            const toolButtons = document.querySelectorAll('.whiteboard-tool');
            toolButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tool = e.currentTarget.dataset.tool;
                    if (currentWhiteboardCanvas) {
                        selectWhiteboardTool(tool);
                    }
                });
            });

            // Color picker
            const colorPicker = document.getElementById('brush-color');
            if (colorPicker) {
                colorPicker.addEventListener('change', (e) => {
                    if (currentWhiteboardCanvas) {
                        currentWhiteboardCanvas.freeDrawingBrush.color = e.target.value;
                    }
                });
            }

            // Brush size
            const brushSize = document.getElementById('brush-size');
            if (brushSize) {
                brushSize.addEventListener('input', (e) => {
                    if (currentWhiteboardCanvas) {
                        currentWhiteboardCanvas.freeDrawingBrush.width = parseInt(e.target.value);
                    }
                });
            }
        }

        function selectWhiteboardTool(tool) {
            if (!currentWhiteboardCanvas) return;

            // Reset to selection mode first
            currentWhiteboardCanvas.isDrawingMode = false;
            currentWhiteboardCanvas.selection = true;

            // Remove active class from all tools
            document.querySelectorAll('.whiteboard-tool').forEach(btn => {
                btn.classList.remove('active');
            });

            // Add active class to selected tool
            const selectedBtn = document.querySelector(`[data-tool="${tool}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('active');
            }

            switch(tool) {
                case 'pen':
                    currentWhiteboardCanvas.isDrawingMode = true;
                    currentWhiteboardCanvas.freeDrawingBrush.width = 3;
                    break;
                    
                case 'text':
                    // Text mode - click to add text
                    currentWhiteboardCanvas.on('mouse:down', function(e) {
                        const pointer = currentWhiteboardCanvas.getPointer(e.e);
                        const text = new fabric.IText('Type here...', {
                            left: pointer.x,
                            top: pointer.y,
                            fontFamily: 'Arial',
                            fontSize: 20,
                            fill: currentWhiteboardCanvas.freeDrawingBrush.color || '#000000'
                        });
                        currentWhiteboardCanvas.add(text);
                        currentWhiteboardCanvas.setActiveObject(text);
                        text.enterEditing();
                    });
                    break;
                    
                case 'rect':
                    currentWhiteboardCanvas.on('mouse:down', function(e) {
                        const pointer = currentWhiteboardCanvas.getPointer(e.e);
                        const rect = new fabric.Rect({
                            left: pointer.x,
                            top: pointer.y,
                            width: 100,
                            height: 60,
                            fill: 'transparent',
                            stroke: currentWhiteboardCanvas.freeDrawingBrush.color || '#000000',
                            strokeWidth: 2
                        });
                        currentWhiteboardCanvas.add(rect);
                    });
                    break;
                    
                case 'circle':
                    currentWhiteboardCanvas.on('mouse:down', function(e) {
                        const pointer = currentWhiteboardCanvas.getPointer(e.e);
                        const circle = new fabric.Circle({
                            left: pointer.x,
                            top: pointer.y,
                            radius: 50,
                            fill: 'transparent',
                            stroke: currentWhiteboardCanvas.freeDrawingBrush.color || '#000000',
                            strokeWidth: 2
                        });
                        currentWhiteboardCanvas.add(circle);
                    });
                    break;
                    
                case 'line':
                    currentWhiteboardCanvas.on('mouse:down', function(e) {
                        const pointer = currentWhiteboardCanvas.getPointer(e.e);
                        const line = new fabric.Line([pointer.x, pointer.y, pointer.x + 100, pointer.y + 100], {
                            stroke: currentWhiteboardCanvas.freeDrawingBrush.color || '#000000',
                            strokeWidth: 2
                        });
                        currentWhiteboardCanvas.add(line);
                    });
                    break;
                    
                case 'eraser':
                    currentWhiteboardCanvas.isDrawingMode = true;
                    currentWhiteboardCanvas.freeDrawingBrush = new fabric.EraserBrush(currentWhiteboardCanvas);
                    currentWhiteboardCanvas.freeDrawingBrush.width = 10;
                    break;
                    
                case 'clear':
                    if (confirm('Clear all content from whiteboard?')) {
                        currentWhiteboardCanvas.clear();
                        currentWhiteboardCanvas.backgroundColor = '#ffffff';
                        saveWhiteboardData();
                    }
                    break;
            }
        }

        function saveWhiteboard() {
            if (!currentWhiteboardCanvas) return;
            
            clearTimeout(whiteboardSaveTimer);
            whiteboardSaveTimer = setTimeout(async () => {
                try {
                    const elements = currentWhiteboardCanvas.toJSON();
                    const activeBoardId = state.activeBoardId || Object.keys(state.content[state.activeFeatureId].boards)[0];
                    console.log('Saving whiteboard data:', JSON.stringify(elements).substring(0, 200) + '...');
                    
                    const result = await apiCall('saveWhiteboard', {
                        featureId: state.activeFeatureId,
                        boardId: activeBoardId,
                        elements: JSON.stringify(elements)
                    });
                    
                    if (result) {
                        console.log('Whiteboard saved successfully');
                        // Merge returned state content instead of replacing whole state
                        try {
                            if (result.content && state.content) {
                                Object.keys(result.content).forEach(k => {
                                    state.content[k] = result.content[k];
                                });
                            }
                            if (result.features && state.features) {
                                Object.keys(result.features).forEach(k => {
                                    state.features[k] = result.features[k];
                                });
                            }
                            window.state = state;
                        } catch (e) {
                            console.warn('Failed to merge whiteboard state, falling back to replace', e);
                            state = result;
                            window.state = state;
                        }
                    } else {
                        console.error('Failed to save whiteboard');
                        showNotification('Failed to save whiteboard', 'error');
                    }
                } catch (error) {
                    console.error('Whiteboard save error:', error);
                    showNotification('Whiteboard save error: ' + error.message, 'error');
                }
            }, 1000);
        }

        // === WikiÊ©üËÉΩ ===
        window.editWikiPage = function() {
            state.isEditingWiki = true;
            render();
        }

        window.cancelWikiEdit = function() {
            state.isEditingWiki = false;
            render();
        }

        window.saveWikiPage = function() {
            const titleElement = document.getElementById('wiki-title-edit');
            const contentElement = document.getElementById('wiki-content-edit');
            
            if (titleElement && contentElement && state.activeWikiPageId) {
                const feature = state.features[state.activeServerId].find(f => f.id === state.activeFeatureId);
                const content = state.content[feature.id];
                
                if (content && content.pages && content.pages[state.activeWikiPageId]) {
                    content.pages[state.activeWikiPageId].title = titleElement.textContent.trim();
                    content.pages[state.activeWikiPageId].content = contentElement.value;
                    content.pages[state.activeWikiPageId].updated_at = Date.now() / 1000;
                    
                    state.isEditingWiki = false;
                    render();
                    showNotification('Wiki page saved successfully', 'success');
                }
            }
        }

        window.createNewWikiPage = function() {
            showModal('add-wiki-page').then(result => {
                if (result) {
                    const feature = state.features[state.activeServerId].find(f => f.id === state.activeFeatureId);
                    const content = state.content[feature.id];
                    
                    if (!content.pages) content.pages = {};
                    
                    const newPageId = 'page_' + Date.now();
                    content.pages[newPageId] = {
                        id: newPageId,
                        title: result.title,
                        content: result.content || '„Åì„Åì„Å´ÂÜÖÂÆπ„ÇíÊõ∏„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ...\n\n**Markdown„Åå‰Ωø„Åà„Åæ„Åô:**\n- „É™„Çπ„ÉàÈ†ÖÁõÆ\n- **Â§™Â≠ó**\n- *Êñú‰Ωì*\n- `„Ç≥„Éº„Éâ`\n\n### Ë¶ãÂá∫„Åó\n\nÊôÆÈÄö„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÄÇ',
                        author: state.currentUser.username || state.currentUser.name,
                        created_at: Date.now() / 1000,
                        updated_at: Date.now() / 1000,
                        tags: result.tags ? result.tags.split(',').map(t => t.trim()) : []
                    };
                    
                    state.activeWikiPageId = newPageId;
                    render();
                    showNotification('Wiki„Éö„Éº„Ç∏„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü', 'success');
                }
            });
        }

        // === ‰∫àÁÆóÊ©üËÉΩ ===
        window.createAccount = function() {
            showModal('create-account').then(result => {
                if (result) {
                    const feature = state.features[state.activeServerId].find(f => f.id === state.activeFeatureId);
                    const content = state.content[feature.id];
                    
                    if (!content.accounts) content.accounts = {};
                    
                    const accountId = 'account_' + Date.now();
                    content.accounts[accountId] = {
                        id: accountId,
                        name: result.name,
                        type: result.type,
                        balance: parseFloat(result.balance) || 0,
                        created_at: Date.now() / 1000
                    };
                    
                    render();
                    showNotification('Account created successfully', 'success');
                }
            });
        }

        window.addTransaction = function() {
            showModal('add-transaction').then(result => {
                if (result) {
                    const feature = state.features[state.activeServerId].find(f => f.id === state.activeFeatureId);
                    const content = state.content[feature.id];
                    
                    if (!content.transactions) content.transactions = {};
                    
                    const transactionId = 'transaction_' + Date.now();
                    const amount = parseFloat(result.amount);
                    
                    content.transactions[transactionId] = {
                        id: transactionId,
                        description: result.description,
                        amount: amount,
                        category: result.category,
                        account_id: result.account_id,
                        date: result.date || new Date().toISOString().split('T')[0],
                        created_at: Date.now() / 1000
                    };
                    
                    // Update account balance
                    if (content.accounts && content.accounts[result.account_id]) {
                        content.accounts[result.account_id].balance += amount;
                    }
                    
                    render();
                    showNotification('Transaction added successfully', 'success');
                }
            });
        }

        // === Áâ©ÂìÅÁÆ°ÁêÜÊ©üËÉΩ ===
        window.addInventoryItem = function() {
            showModal('add-inventory-item').then(result => {
                if (result) {
                    const feature = state.features[state.activeServerId].find(f => f.id === state.activeFeatureId);
                    const content = state.content[feature.id];
                    
                    if (!content.items) content.items = {};
                    
                    const itemId = 'item_' + Date.now();
                    content.items[itemId] = {
                        id: itemId,
                        name: result.name,
                        category: result.category,
                        quantity: parseInt(result.quantity) || 1,
                        location: result.location,
                        condition: result.condition || 'good',
                        description: result.description || '',
                        added_by: state.currentUser.name,
                        created_at: Date.now() / 1000
                    };
                    
                    render();
                    showNotification('Item added successfully', 'success');
                }
            });
        }

        window.generateInventoryReport = function() {
            showNotification('Inventory report generated', 'success');
        }

        // === „É°„É≥„Éê„ÉºÁÆ°ÁêÜÊ©üËÉΩ ===
        window.inviteMember = function() {
            showModal('invite-member').then(result => {
                if (result) {
                    const feature = state.features[state.activeServerId].find(f => f.id === state.activeFeatureId);
                    const content = state.content[feature.id];
                    
                    if (!content.members) content.members = {};
                    
                    const memberId = 'member_' + Date.now();
                    content.members[memberId] = {
                        id: memberId,
                        name: result.name,
                        email: result.email,
                        role: result.role || 'member',
                        admission_year: parseInt(result.admission_year) || new Date().getFullYear(),
                        nickname: result.nickname || result.name,
                        status: 'invited',
                        invited_by: state.currentUser.name,
                        created_at: Date.now() / 1000
                    };
                    
                    render();
                    showNotification('Member invited successfully', 'success');
                }
            });
        }

        window.manageRoles = function() {
            showNotification('Role management panel opened', 'info');
        }

        window.filterByYear = function() {
            showNotification('Year filter applied', 'info');
        }

        // === „Ç¢„É´„Éê„É†Ê©üËÉΩ ===
        window.createAlbum = function() {
            showModal('create-album').then(result => {
                if (result) {
                    const feature = state.features[state.activeServerId].find(f => f.id === state.activeFeatureId);
                    const content = state.content[feature.id];
                    
                    if (!content.albums) content.albums = {};
                    
                    const albumId = 'album_' + Date.now();
                    content.albums[albumId] = {
                        id: albumId,
                        name: result.name,
                        description: result.description || '',
                        photos: [],
                        created_by: state.currentUser.name,
                        created_at: Date.now() / 1000
                    };
                    
                    state.activeAlbumId = albumId;
                    render();
                    showNotification('Album created successfully', 'success');
                }
            });
        }

        window.uploadPhoto = function() {
            showModal('upload-photo').then(result => {
                if (result) {
                    const feature = state.features[state.activeServerId].find(f => f.id === state.activeFeatureId);
                    const content = state.content[feature.id];
                    
                    if (content.albums && content.albums[state.activeAlbumId]) {
                        const photoId = 'photo_' + Date.now();
                        content.albums[state.activeAlbumId].photos.push({
                            id: photoId,
                            title: result.title,
                            url: result.url || 'https://via.placeholder.com/300x200',
                            uploaded_by: state.currentUser.name,
                            created_at: Date.now() / 1000
                        });
                        
                        render();
                        showNotification('Photo uploaded successfully', 'success');
                    }
                }
            });
        }

        // === Ë®≠ÂÆöÊ©üËÉΩ ===
        window.openSettings = function() {
            showModal('user-settings').then(result => {
                if (result) {
                    // Update user settings
                    Object.keys(result).forEach(key => {
                        if (state.currentUser.hasOwnProperty(key)) {
                            state.currentUser[key] = result[key];
                        }
                    });
                    
                    render();
                    showNotification('Settings updated successfully', 'success');
                }
            });
        }

        // === „Ç´„É¨„É≥„ÉÄ„ÉºÊ©üËÉΩ ===


        // === ÂàùÊúüÂåñÈñ¢Êï∞ ===
        const initializeApp = (initialState) => { 
            // Defensive initialization: require a valid object with currentUser
            if (!initialState || typeof initialState !== 'object' || !initialState.currentUser) {
                console.warn('initializeApp called with invalid state, ignoring:', initialState);
                // If we have an existing signed-in state, keep it; otherwise show auth
                if (state && state.currentUser) {
                    // keep current state
                    render();
                    return;
                }
                showAuth('login');
                return;
            }

            // Merge returned state into existing state to avoid losing UI actives
            try {
                Object.keys(initialState).forEach(k => state[k] = initialState[k]);
            } catch (e) {
                state = initialState || {};
            }

            window.state = state; // Make state globally accessible for debugging
            document.getElementById('auth-container').innerHTML = ''; 
            loggedIn = true;
            // Force app to be visible
            const appEl = document.getElementById('app');
            if (appEl) appEl.classList.remove('hidden');
            render(); 
        };
        
        const showAuth = (type = 'login') => { 
            // older code used 'login' name; templates use 'auth' for the login form
            const key = (type === 'login') ? 'auth' : type;
            const tpl = TEMPLATES[key];
            if (typeof tpl === 'function') {
                document.getElementById('auth-container').innerHTML = tpl();
            } else {
                console.error('Unknown auth template:', type);
                document.getElementById('auth-container').innerHTML = '<div class="modal-backdrop"><div class="glass-effect p-8 rounded-lg">„ÉÜ„É≥„Éó„É¨„Éº„Éà„Ç®„É©„Éº</div></div>';
            }
        };

        // === „Ç¢„ÇØ„Ç∑„Éß„É≥ÂÆöÁæ© ===
        const ACTIONS = {
            login: async (form) => { 
                const data = await apiCall('login', { 
                    username: form.username.value, 
                    password: form.password.value 
                }); 
                if (data) {
                    initializeApp(data.state);
                    showNotification('„É≠„Ç∞„Ç§„É≥„Åó„Åæ„Åó„Åü', 'success');
                }
            },
            
            register: async (form) => { 
                const data = await apiCall('register', { 
                    username: form.username.value, 
                    password: form.password.value 
                }); 
                if(data) { 
                    showNotification('ÁôªÈå≤„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü', 'success'); 
                    showAuth('login'); 
                } 
            },
            
            logout: async () => { 
                await apiCall('logout'); 
                state = {}; 
                document.getElementById('app').classList.add('hidden'); 
                showAuth('login');
                showNotification('„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü', 'info');
            },
            
            showRegister: () => showAuth('register'),
            showLogin: () => showAuth('login'),
            showPasswordRecovery: () => {
                showModal('password-recovery').then(async result => {
                    if (result) {
                        const data = await apiCall('requestPasswordRecovery', result);
                        if (data) {
                            showNotification('„Éë„Çπ„ÉØ„Éº„ÉâÂæ©Êóß„É™„ÇØ„Ç®„Çπ„Éà„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü„ÄÇ„Éë„Éº„Éà„Éä„Éº„ÅÆÊâøË™ç„Çí„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ„ÄÇ', 'info');
                            showAuth('login');
                        }
                    }
                });
            },
            
            updateProfile: () => {
                showModal('user-settings').then(async result => {
                    if (result) {
                        const data = await apiCall('updateProfile', result);
                        if (data) {
                            initializeApp(data);
                            showNotification('„Éó„É≠„Éï„Ç£„Éº„É´„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü', 'success');
                        }
                    }
                });
            },
            
            createInvite: async () => {
                const data = await apiCall('createInvite', { serverId: state.activeServerId });
                if (data) {
                    showNotification(`ÊãõÂæÖ„Ç≥„Éº„Éâ: ${data.inviteCode} (24ÊôÇÈñìÊúâÂäπ)`, 'success');
                }
            },
            
            joinServer: () => {
                showModal('join-server').then(async result => {
                    if (result) {
                        const data = await apiCall('acceptInvite', result);
                        if (data) {
                            initializeApp(data);
                            showNotification('„Çµ„Éº„Éê„Éº„Å´ÂèÇÂä†„Åó„Åæ„Åó„Åü', 'success');
                        }
                    }
                });
            },
            
            'add-server': async () => { 
                const result = await showModal('add-server'); 
                if(result) { 
                    const data = await apiCall('addServer', result); 
                    if (data) {
                        // Merge returned state into existing state to preserve active IDs
                        const prevActive = { serverId: state.activeServerId, featureId: state.activeFeatureId, subItemId: state.activeSubItemId };
                        state = Object.assign({}, state, data);
                        // restore prev actives if still valid
                        if (prevActive.serverId && state.servers && state.servers[prevActive.serverId]) state.activeServerId = prevActive.serverId;
                        if (prevActive.featureId) state.activeFeatureId = prevActive.featureId;
                        if (prevActive.subItemId) state.activeSubItemId = prevActive.subItemId;
                        window.state = state;
                        render();
                        showNotification(`Server "${result.name}" created successfully`, 'success');
                    }
                } 
            },
            
            'add-subitem': async () => { 
                const result = await showModal('add-subitem'); 
                if(result) { 
                    const data = await apiCall('addSubItem', { 
                        featureId: state.activeFeatureId, 
                        name: result.name,
                        type: result.type || 'channel'
                    }); 
                    if(data) {
                        // Merge returned data into current state to avoid losing active IDs
                        const currentActiveServerId = state.activeServerId;
                        const currentActiveFeatureId = state.activeFeatureId;
                        try {
                            Object.keys(data).forEach(k => { state[k] = data[k]; });
                        } catch (e) { state = data; }
                        state.activeServerId = currentActiveServerId;
                        state.activeFeatureId = currentActiveFeatureId;
                        state.currentUser = data.currentUser || state.currentUser;
                        window.state = state;
                        render();
                        
                        showNotification(`${result.type === 'thread' ? 'Thread' : 'Channel'} "${result.name}" created successfully`, 'success');
                    }
                } 
            },

            'add-whiteboard': async () => {
                const result = await showModal('add-whiteboard');
                if(result) {
                    const data = await apiCall('addWhiteboard', {
                        featureId: state.activeFeatureId,
                        name: result.name
                    });
                    if(data) {
                        initializeApp(data);
                        showNotification(`„Éõ„ÉØ„Ç§„Éà„Éú„Éº„Éâ„Äå${result.name}„Äç„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü`, 'success');
                    }
                }
            },

            'create-survey': async () => {
                const result = await showModal('create-survey');
                if(result) {
                    const content = state.content[state.activeFeatureId] || {};
                    
                    if (!content.surveys) content.surveys = {};
                    
                    const surveyId = Date.now().toString();
                    content.surveys[surveyId] = {
                        id: surveyId,
                        title: result.title,
                        questions: result.questions,
                        responses: [],
                        created_at: Date.now() / 1000,
                        author: state.currentUser.username
                    };
                    
                    // „Çµ„Éº„Éê„Éº„Å´‰øùÂ≠ò
                    const saved = await updateFeatureContent(state.activeFeatureId, content);
                    if (saved) {
                        state.activeSurveyId = surveyId;
                        render();
                        showNotification(`„Ç¢„É≥„Ç±„Éº„Éà„Äå${result.title}„Äç„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü`, 'success');
                    } else {
                        showNotification('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                    }
                }
            },

            // WikiÁÆ°ÁêÜ„Ç¢„ÇØ„Ç∑„Éß„É≥
            'create-wiki-page': async () => {
                const result = await showModal('add-wiki-page');
                if (result) {
                    const content = state.content[state.activeFeatureId] || {};
                    
                    if (!content.pages) content.pages = {};
                    
                    const pageId = Date.now().toString();
                    content.pages[pageId] = {
                        id: pageId,
                        title: result.title,
                        content: result.content || '',
                        author: state.currentUser.username,
                        created_at: Date.now() / 1000,
                        updated_at: Date.now() / 1000
                    };
                    
                    // „Çµ„Éº„Éê„Éº„Å´‰øùÂ≠ò
                    const saved = await updateFeatureContent(state.activeFeatureId, content);
                    if (saved) {
                        state.activeWikiPageId = pageId;
                        render();
                        showNotification(`Wiki„Éö„Éº„Ç∏„Äå${result.title}„Äç„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü`, 'success');
                    } else {
                        showNotification('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                    }
                }
            },

            'create-project': async () => {
                const result = await showModal('create-project');
                if(result) {
                    const data = await apiCall('createProject', {
                        featureId: state.activeFeatureId,
                        name: result.name,
                        description: result.description
                    });
                    if(data) {
                        initializeApp(data);
                        showNotification(`„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Äå${result.name}„Äç„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü`, 'success');
                    }
                }
            },

            'create-task': async () => {
                const result = await showModal('create-task');
                if(result && state.activeProjectId) {
                    const data = await apiCall('createTask', {
                        featureId: state.activeFeatureId,
                        projectId: state.activeProjectId,
                        title: result.title,
                        description: result.description,
                        priority: result.priority
                    });
                    if(data) {
                        initializeApp(data);
                        showNotification(`„Çø„Çπ„ÇØ„Äå${result.title}„Äç„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü`, 'success');
                    }
                }
            },

            'update-task-status': async (element) => {
                const taskId = element.dataset.taskId;
                const status = element.dataset.status;
                if(taskId && status) {
                    const data = await apiCall('updateTaskStatus', {
                        featureId: state.activeFeatureId,
                        taskId: taskId,
                        status: status
                    });
                    if(data) {
                        initializeApp(data);
                        showNotification('„Çø„Çπ„ÇØ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü', 'success');
                    }
                }
            },

            'whiteboard-tool': (element) => {
                if (!currentWhiteboardCanvas) return;
                const tool = element.dataset.tool;
                
                // Reset all tool buttons
                document.querySelectorAll('.whiteboard-tool').forEach(btn => btn.classList.remove('active'));
                element.classList.add('active');
                
                if (tool === 'pen') {
                    currentWhiteboardCanvas.isDrawingMode = true;
                } else {
                    currentWhiteboardCanvas.isDrawingMode = false;
                    
                    if (tool === 'text') {
                        // Text tool implementation
                        currentWhiteboardCanvas.on('mouse:down', function(e) {
                            const pointer = currentWhiteboardCanvas.getPointer(e.e);
                            const text = new fabric.IText('Click to edit', {
                                left: pointer.x,
                                top: pointer.y,
                                fontFamily: 'Arial',
                                fontSize: 20,
                                fill: document.getElementById('brush-color')?.value || '#000000'
                            });
                            currentWhiteboardCanvas.add(text);
                        });
                    } else if (tool === 'rect') {
                        // Rectangle tool
                        let isDown, origX, origY;
                        currentWhiteboardCanvas.on('mouse:down', function(e) {
                            isDown = true;
                            const pointer = currentWhiteboardCanvas.getPointer(e.e);
                            origX = pointer.x;
                            origY = pointer.y;
                        });
                        
                        currentWhiteboardCanvas.on('mouse:up', function(e) {
                            if (!isDown) return;
                            isDown = false;
                            const pointer = currentWhiteboardCanvas.getPointer(e.e);
                            const rect = new fabric.Rect({
                                left: Math.min(origX, pointer.x),
                                top: Math.min(origY, pointer.y),
                                width: Math.abs(pointer.x - origX),
                                height: Math.abs(pointer.y - origY),
                                fill: 'transparent',
                                stroke: document.getElementById('brush-color')?.value || '#000000',
                                strokeWidth: parseInt(document.getElementById('brush-size')?.value) || 2
                            });
                            currentWhiteboardCanvas.add(rect);
                        });
                    } else if (tool === 'circle') {
                        // Circle tool
                        let isDown, origX, origY;
                        currentWhiteboardCanvas.on('mouse:down', function(e) {
                            isDown = true;
                            const pointer = currentWhiteboardCanvas.getPointer(e.e);
                            origX = pointer.x;
                            origY = pointer.y;
                        });
                        
                        currentWhiteboardCanvas.on('mouse:up', function(e) {
                            if (!isDown) return;
                            isDown = false;
                            const pointer = currentWhiteboardCanvas.getPointer(e.e);
                            const radius = Math.sqrt(Math.pow(pointer.x - origX, 2) + Math.pow(pointer.y - origY, 2)) / 2;
                            const circle = new fabric.Circle({
                                left: Math.min(origX, pointer.x),
                                top: Math.min(origY, pointer.y),
                                radius: radius,
                                fill: 'transparent',
                                stroke: document.getElementById('brush-color')?.value || '#000000',
                                strokeWidth: parseInt(document.getElementById('brush-size')?.value) || 2
                            });
                            currentWhiteboardCanvas.add(circle);
                        });
                    } else if (tool === 'line') {
                        // Line tool
                        let isDown, origX, origY;
                        currentWhiteboardCanvas.on('mouse:down', function(e) {
                            isDown = true;
                            const pointer = currentWhiteboardCanvas.getPointer(e.e);
                            origX = pointer.x;
                            origY = pointer.y;
                        });
                        
                        currentWhiteboardCanvas.on('mouse:up', function(e) {
                            if (!isDown) return;
                            isDown = false;
                            const pointer = currentWhiteboardCanvas.getPointer(e.e);
                            const line = new fabric.Line([origX, origY, pointer.x, pointer.y], {
                                stroke: document.getElementById('brush-color')?.value || '#000000',
                                strokeWidth: parseInt(document.getElementById('brush-size')?.value) || 2
                            });
                            currentWhiteboardCanvas.add(line);
                        });
                    }
                }
            },

            'whiteboard-clear': () => {
                clearWhiteboard();
            },

            'whiteboard-save': () => {
                saveWhiteboard();
            },

            'whiteboard-export': () => {
                exportWhiteboard();
            },

            'upload-file': () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.multiple = true;
                input.onchange = async (e) => {
                    const files = Array.from(e.target.files);
                    for (const file of files) {
                        const formData = new FormData();
                        formData.append('action', 'uploadFile');
                        formData.append('file', file);
                        formData.append('serverId', state.activeServerId);
                        formData.append('featureId', state.activeFeatureId);
                        
                        try {
                            const response = await fetch('/api.cgi', {
                                method: 'POST',
                                body: formData,
                                credentials: 'include'
                            });
                            const result = await response.json();
                            if (result.success) {
                                showNotification(`${file.name} „Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü`, 'success');
                            } else {
                                showNotification(`${file.name} „ÅÆ„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó: ${result.error}`, 'error');
                            }
                        } catch (error) {
                            showNotification(`${file.name} „ÅÆ„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Ç®„É©„Éº`, 'error');
                            console.error('Upload error:', error);
                        }
                    }
                    // Refresh content after upload
                    const data = await apiCall('checkSession');
                    if (data && data.state) {
                        initializeApp(data.state);
                    }
                };
                input.click();
            },

            'calendar-prev': () => {
                if (!state.calendarDate) {
                    state.calendarDate = new Date();
                }
                state.calendarDate.setMonth(state.calendarDate.getMonth() - 1);
                render();
            },

            'calendar-next': () => {
                if (!state.calendarDate) {
                    state.calendarDate = new Date();
                }
                state.calendarDate.setMonth(state.calendarDate.getMonth() + 1);
                render();
            },

            'create-event': async () => {
                const result = await showModal('create-event');
                if (result) {
                    const content = state.content[state.activeFeatureId] || {};
                    
                    if (!content.events) content.events = {};
                    
                    const eventId = Date.now().toString();
                    content.events[eventId] = {
                        id: eventId,
                        title: result.title,
                        description: result.description,
                        date: result.date,
                        time: result.time,
                        createdBy: state.currentUser.username,
                        createdAt: Date.now() / 1000
                    };
                    
                    // „Çµ„Éº„Éê„Éº„Å´‰øùÂ≠ò
                    const saved = await updateFeatureContent(state.activeFeatureId, content);
                    if (saved) {
                        render();
                        showNotification(`„Ç§„Éô„É≥„Éà„Äå${result.title}„Äç„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü`, 'success');
                    } else {
                        showNotification('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                    }
                }
            },

            // ‰∫àÁÆóÁÆ°ÁêÜ„Ç¢„ÇØ„Ç∑„Éß„É≥
            'add-transaction': async () => {
                const result = await showModal('add-transaction');
                if (result) {
                    const content = state.content[state.activeFeatureId] || {};
                    
                    if (!content.transactions) content.transactions = {};
                    if (!content.accounts) content.accounts = {};
                    
                    const transactionId = Date.now().toString();
                    content.transactions[transactionId] = {
                        id: transactionId,
                        description: result.description,
                        amount: parseFloat(result.amount),
                        category: result.category,
                        account: result.account,
                        date: result.date || new Date().toISOString().split('T')[0],
                        createdBy: state.currentUser.username,
                        createdAt: Date.now()
                    };
                    
                    // Update account balance if account exists
                    if (result.account && content.accounts[result.account]) {
                        content.accounts[result.account].balance += parseFloat(result.amount);
                    }
                    
                    // „Çµ„Éº„Éê„Éº„Å´‰øùÂ≠ò
                    const saved = await updateFeatureContent(state.activeFeatureId, content);
                    if (saved) {
                        render();
                        showNotification(`ÂèñÂºï„Äå${result.description}„Äç„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü`, 'success');
                    } else {
                        showNotification('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                    }
                }
            },

            'create-account': async () => {
                const result = await showModal('create-account');
                if (result) {
                    const content = state.content[state.activeFeatureId] || {};
                    
                    if (!content.accounts) content.accounts = {};
                    
                    const accountId = Date.now().toString();
                    content.accounts[accountId] = {
                        id: accountId,
                        name: result.name,
                        type: result.type,
                        balance: parseFloat(result.balance || 0),
                        createdBy: state.currentUser.username,
                        createdAt: Date.now()
                    };
                    
                    // „Çµ„Éº„Éê„Éº„Å´‰øùÂ≠ò
                    const saved = await updateFeatureContent(state.activeFeatureId, content);
                    if (saved) {
                        render();
                        showNotification(`Âè£Â∫ß„Äå${result.name}„Äç„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü`, 'success');
                    } else {
                        showNotification('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                    }
                }
            },

            // Áâ©ÂìÅÁÆ°ÁêÜ„Ç¢„ÇØ„Ç∑„Éß„É≥
            'add-inventory-item': async () => {
                const result = await showModal('add-inventory-item');
                if (result) {
                    const content = state.content[state.activeFeatureId] || {};
                    
                    if (!content.items) content.items = {};
                    
                    const itemId = Date.now().toString();
                    content.items[itemId] = {
                        id: itemId,
                        name: result.name,
                        category: result.category,
                        location: result.location,
                        quantity: parseInt(result.quantity || 0),
                        unitPrice: parseFloat(result.unitPrice || 0),
                        minStock: parseInt(result.minStock || 5),
                        status: result.status || 'available',
                        description: result.description,
                        createdBy: state.currentUser.username,
                        createdAt: Date.now()
                    };
                    
                    // „Çµ„Éº„Éê„Éº„Å´‰øùÂ≠ò
                    const saved = await updateFeatureContent(state.activeFeatureId, content);
                    if (saved) {
                        render();
                        showNotification(`„Ç¢„Ç§„ÉÜ„É†„Äå${result.name}„Äç„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü`, 'success');
                    } else {
                        showNotification('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                    }
                }
            },

            // „Ç¢„É´„Éê„É†ÁÆ°ÁêÜ„Ç¢„ÇØ„Ç∑„Éß„É≥
            'create-album': async () => {
                const result = await showModal('create-album');
                if (result) {
                    const content = state.content[state.activeFeatureId] || {};
                    
                    if (!content.albums) content.albums = {};
                    
                    const albumId = Date.now().toString();
                    content.albums[albumId] = {
                        id: albumId,
                        title: result.title,
                        description: result.description,
                        photos: [],
                        createdBy: state.currentUser.username,
                        createdAt: Date.now()
                    };
                    
                    // „Çµ„Éº„Éê„Éº„Å´‰øùÂ≠ò
                    const saved = await updateFeatureContent(state.activeFeatureId, content);
                    if (saved) {
                        state.activeAlbumId = albumId;
                        render();
                        showNotification(`„Ç¢„É´„Éê„É†„Äå${result.title}„Äç„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü`, 'success');
                    } else {
                        showNotification('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                    }
                }
            },

            'upload-photos': () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.multiple = true;
                input.accept = 'image/*';
                input.onchange = async (e) => {
                    const files = Array.from(e.target.files);
                    const feature = state.features[state.activeServerId].find(f => f.id === state.activeFeatureId);
                    const content = state.content[feature.id] || {};
                    
                    if (!content.albums) content.albums = {};
                    if (!content.albums[state.activeAlbumId]) return;
                    
                    for (const file of files) {
                        // „Åì„Åì„Åß„ÅØÂÆüÈöõ„ÅÆ„Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„ÅÆ‰ª£„Çè„Çä„Å´„ÉÄ„Éü„Éº„Éá„Éº„Çø„ÇíËøΩÂä†
                        const photoId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                        content.albums[state.activeAlbumId].photos.push({
                            id: photoId,
                            filename: file.name,
                            uploadedBy: state.currentUser.username,
                            uploadedAt: Date.now()
                        });
                    }
                    
                    state.content[feature.id] = content;
                    render();
                    showNotification(`${files.length}Êûö„ÅÆÂÜôÁúü„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü`, 'success');
                };
                input.click();
            },

            // Êó•Ë®òÁÆ°ÁêÜ„Ç¢„ÇØ„Ç∑„Éß„É≥
            'create-diary-entry': async () => {
                const result = await showModal('create-diary-entry');
                if (result) {
                    const content = state.content[state.activeFeatureId] || {};
                    
                    if (!content.entries) content.entries = {};
                    
                    const entryId = Date.now().toString();
                    content.entries[entryId] = {
                        id: entryId,
                        title: result.title,
                        content: result.content,
                        mood: result.mood,
                        tags: result.tags ? result.tags.split(',').map(t => t.trim()) : [],
                        private: result.private || false,
                        author: state.currentUser.username,
                        created_at: Date.now() / 1000
                    };
                    
                    // „Çµ„Éº„Éê„Éº„Å´‰øùÂ≠ò
                    const saved = await updateFeatureContent(state.activeFeatureId, content);
                    if (saved) {
                        render();
                        showNotification(`Êó•Ë®ò„Äå${result.title}„Äç„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü`, 'success');
                    } else {
                        showNotification('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                    }
                }
            }
        };

        // === „É°„É≥„Éê„ÉºÁÆ°ÁêÜÈñ¢Êï∞ ===
        window.loadServerMembers = async function() {
            if (!state.activeServerId) return;
            
            const data = await apiCall('getServerMembers', {
                serverId: state.activeServerId
            });
            
            if (data) {
                if (!state.serverMembers) state.serverMembers = {};
                state.serverMembers[state.activeServerId] = data.members;
                render();
                showNotification('„É°„É≥„Éê„ÉºÊÉÖÂ†±„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü', 'success');
            }
        };

        window.updateMemberRole = async function(userId, newRole) {
            const data = await apiCall('updateMemberRole', {
                serverId: state.activeServerId,
                userId: userId,
                role: newRole
            });
            
            if (data) {
                loadServerMembers(); // „É™„É≠„Éº„Éâ
                showNotification('„É°„É≥„Éê„Éº„ÅÆ„É≠„Éº„É´„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü', 'success');
            }
        };

        // === Markdown„É¨„É≥„ÉÄ„É™„É≥„Ç∞Èñ¢Êï∞ ===
        function renderMarkdown(text) {
            if (!text) return '';
            
            return text
                // Ë¶ãÂá∫„Åó
                .replace(/^### (.*$)/gim, '<h3 class="text-xl font-bold text-white mt-6 mb-3">$1</h3>')
                .replace(/^## (.*$)/gim, '<h2 class="text-2xl font-bold text-white mt-8 mb-4">$1</h2>')
                .replace(/^# (.*$)/gim, '<h1 class="text-3xl font-bold text-white mt-8 mb-6">$1</h1>')
                // Â§™Â≠ó„ÉªÊñú‰Ωì
                .replace(/\*\*(.*?)\*\*/g, '<strong class="font-bold text-white">$1</strong>')
                .replace(/\*(.*?)\*/g, '<em class="italic text-gray-200">$1</em>')
                // „É™„É≥„ÇØ
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" class="text-blue-400 hover:text-blue-300 underline" target="_blank">$1</a>')
                // „Ç≥„Éº„Éâ„Éñ„É≠„ÉÉ„ÇØ
                .replace(/```([\s\S]*?)```/g, '<pre class="bg-black/30 p-4 rounded-lg my-4 overflow-x-auto"><code class="text-green-400 font-mono text-sm">$1</code></pre>')
                // „Ç§„É≥„É©„Ç§„É≥„Ç≥„Éº„Éâ
                .replace(/`([^`]+)`/g, '<code class="bg-black/30 px-2 py-1 rounded text-green-400 font-mono text-sm">$1</code>')
                // „É™„Çπ„Éà
                .replace(/^\* (.*$)/gim, '<li class="text-gray-200 ml-4">‚Ä¢ $1</li>')
                .replace(/^- (.*$)/gim, '<li class="text-gray-200 ml-4">‚Ä¢ $1</li>')
                .replace(/^\d+\. (.*$)/gim, '<li class="text-gray-200 ml-4 list-decimal">$1</li>')
                // ÊîπË°å
                .replace(/\n\n/g, '</p><p class="text-gray-200 mb-4">')
                .replace(/\n/g, '<br>')
                // ÊÆµËêΩ„ÅßÂõ≤„ÇÄ
                .replace(/^/, '<p class="text-gray-200 mb-4">')
                .replace(/$/, '</p>');
        }

        // === „Åù„ÅÆ‰ªñ„ÅÆ„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞ ===
        window.openSettings = function() {
            ACTIONS.updateProfile();
        }

        window.toggleSurveyResults = function() {
            state.showSurveyResults = !state.showSurveyResults;
            render();
        }

        window.deleteSurvey = function(surveyId) {
            if (confirm('„Åì„ÅÆ„Ç¢„É≥„Ç±„Éº„Éà„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                const feature = state.features[state.activeServerId].find(f => f.id === state.activeFeatureId);
                const content = state.content[feature.id];
                
                if (content.surveys && content.surveys[surveyId]) {
                    delete content.surveys[surveyId];
                    if (content.responses && content.responses[surveyId]) {
                        delete content.responses[surveyId];
                    }
                    
                    // ‰ªñ„ÅÆ„Ç¢„É≥„Ç±„Éº„Éà„Åå„ÅÇ„Çå„Å∞ÊúÄÂàù„ÅÆ„ÇÇ„ÅÆ„ÇíÈÅ∏Êäû
                    const remainingSurveys = Object.keys(content.surveys);
                    if (remainingSurveys.length > 0) {
                        state.activeSurveyId = remainingSurveys[0];
                    } else {
                        state.activeSurveyId = null;
                    }
                    
                    render();
                    showNotification('„Ç¢„É≥„Ç±„Éº„Éà„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
                }
            }
        }

        window.deleteTask = function(taskId) {
            if (confirm('„Åì„ÅÆ„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                const feature = state.features[state.activeServerId].find(f => f.id === state.activeFeatureId);
                const content = state.content[feature.id];
                
                if (content.projects && state.activeProjectId && content.projects[state.activeProjectId]) {
                    const project = content.projects[state.activeProjectId];
                    if (project.tasks && project.tasks[taskId]) {
                        delete project.tasks[taskId];
                        render();
                        showNotification('„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
                    }
                }
            }
        }

        window.deleteAccount = function(accountId) {
            if (confirm('„Åì„ÅÆÂè£Â∫ß„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                const feature = state.features[state.activeServerId].find(f => f.id === state.activeFeatureId);
                const content = state.content[feature.id];
                
                if (content.accounts && content.accounts[accountId]) {
                    delete content.accounts[accountId];
                    render();
                    showNotification('Âè£Â∫ß„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
                }
            }
        }

        window.deleteTransaction = function(transactionId) {
            if (confirm('„Åì„ÅÆÂèñÂºï„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                const feature = state.features[state.activeServerId].find(f => f.id === state.activeFeatureId);
                const content = state.content[feature.id];
                
                if (content.transactions && content.transactions[transactionId]) {
                    delete content.transactions[transactionId];
                    render();
                    showNotification('ÂèñÂºï„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
                }
            }
        }

        window.deleteFile = function(fileId) {
            if (confirm('„Åì„ÅÆ„Éï„Ç°„Ç§„É´„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                const feature = state.features[state.activeServerId].find(f => f.id === state.activeFeatureId);
                const content = state.content[feature.id];
                
                if (content.folders && content.folders.root && content.folders.root.files) {
                    content.folders.root.files = content.folders.root.files.filter(f => f.id !== fileId);
                    render();
                    showNotification('„Éï„Ç°„Ç§„É´„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
                }
            }
        }

        window.downloadFile = function(fileId, fileName) {
            // „Éï„Ç°„Ç§„É´„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÊ©üËÉΩ„ÅÆÂÆüË£Ö
            showNotification(`${fileName} „ÅÆ„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„ÇíÈñãÂßã„Åó„Åæ„Åô`, 'info');
        }

        window.deleteWikiPage = function(pageId) {
            if (confirm('„Åì„ÅÆWiki„Éö„Éº„Ç∏„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                const feature = state.features[state.activeServerId].find(f => f.id === state.activeFeatureId);
                const content = state.content[feature.id];
                
                if (content.pages && content.pages[pageId]) {
                    delete content.pages[pageId];
                    
                    // ‰ªñ„ÅÆ„Éö„Éº„Ç∏„Åå„ÅÇ„Çå„Å∞ÊúÄÂàù„ÅÆ„ÇÇ„ÅÆ„ÇíÈÅ∏Êäû
                    const remainingPages = Object.keys(content.pages);
                    if (remainingPages.length > 0) {
                        state.activeWikiPageId = remainingPages[0];
                    } else {
                        state.activeWikiPageId = null;
                    }
                    
                    render();
                    showNotification('Wiki„Éö„Éº„Ç∏„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
                }
            }
        }

        window.deleteInventoryItem = function(itemId) {
            if (confirm('„Åì„ÅÆ„Ç¢„Ç§„ÉÜ„É†„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                const feature = state.features[state.activeServerId].find(f => f.id === state.activeFeatureId);
                const content = state.content[feature.id];
                
                if (content.items && content.items[itemId]) {
                    delete content.items[itemId];
                    render();
                    showNotification('„Ç¢„Ç§„ÉÜ„É†„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
                }
            }
        }

        window.deletePhoto = function(albumId, photoIndex) {
            if (confirm('„Åì„ÅÆÂÜôÁúü„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                const feature = state.features[state.activeServerId].find(f => f.id === state.activeFeatureId);
                const content = state.content[feature.id];
                
                if (content.albums && content.albums[albumId] && content.albums[albumId].photos) {
                    content.albums[albumId].photos.splice(photoIndex, 1);
                    render();
                    showNotification('ÂÜôÁúü„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
                }
            }
        }

        window.deleteDiaryEntry = function(entryId) {
            if (confirm('„Åì„ÅÆÊó•Ë®ò„Ç®„É≥„Éà„É™„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                const feature = state.features[state.activeServerId].find(f => f.id === state.activeFeatureId);
                const content = state.content[feature.id];
                
                if (content.entries && content.entries[entryId]) {
                    delete content.entries[entryId];
                    render();
                    showNotification('Êó•Ë®ò„Ç®„É≥„Éà„É™„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
                }
            }
        }

        window.kickMember = function(memberId) {
            if (confirm('„Åì„ÅÆ„É°„É≥„Éê„Éº„Çí„Çµ„Éº„Éê„Éº„Åã„Çâ„Ç≠„ÉÉ„ÇØ„Åó„Åæ„Åô„ÅãÔºü')) {
                // API„Ç≥„Éº„É´„Åß„É°„É≥„Éê„Éº„Ç≠„ÉÉ„ÇØÂá¶ÁêÜ„ÇíÂÆüË£Ö
                apiCall('kickMember', {
                    serverId: state.activeServerId,
                    memberId: memberId
                }).then(data => {
                    if (data) {
                        showNotification('„É°„É≥„Éê„Éº„Çí„Ç≠„ÉÉ„ÇØ„Åó„Åæ„Åó„Åü', 'success');
                        // „É°„É≥„Éê„Éº„É™„Çπ„Éà„ÇíÂÜçË™≠„ÅøËæº„Åø
                        loadServerMembers();
                    }
                });
            }
        }

        window.updateMemberRole = function(memberId, newRole) {
            apiCall('updateMemberRole', {
                serverId: state.activeServerId,
                memberId: memberId,
                role: newRole
            }).then(data => {
                if (data) {
                    showNotification('„É°„É≥„Éê„Éº„ÅÆÂΩπÂâ≤„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü', 'success');
                    loadServerMembers();
                }
            });
        }

        // === „Éï„Ç°„Ç§„É´ÁÆ°ÁêÜÈñ¢Êï∞ ===
        function formatFileSize(bytes) {
            if (!bytes) return 'Unknown';
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function getBreadcrumb(folders, currentId) {
            const breadcrumb = [];
            let current = folders[currentId];
            
            while (current) {
                breadcrumb.unshift({ id: currentId, name: current.name });
                currentId = current.parentId;
                current = currentId ? folders[currentId] : null;
            }
            
            return breadcrumb;
        }

        window.navigateToFolder = function(folderId) {
            const feature = state.features[state.activeServerId].find(f => f.id === state.activeFeatureId);
            const content = state.content[feature.id];
            
            if (!content.folders) content.folders = { root: { name: '„É´„Éº„Éà', files: [], subfolders: [] } };
            content.currentFolder = folderId;
            render();
        }

        window.createFolder = function() {
            const folderName = prompt('„Éï„Ç©„É´„ÉÄÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:');
            if (!folderName) return;
            
            const feature = state.features[state.activeServerId].find(f => f.id === state.activeFeatureId);
            const content = state.content[feature.id];
            
            if (!content.folders) content.folders = { root: { name: '„É´„Éº„Éà', files: [], subfolders: [] } };
            const currentFolderId = content.currentFolder || 'root';
            const currentFolder = content.folders[currentFolderId];
            
            const newFolderId = 'folder_' + Date.now();
            content.folders[newFolderId] = {
                id: newFolderId,
                name: folderName,
                parentId: currentFolderId,
                files: [],
                subfolders: [],
                createdAt: Date.now()
            };
            
            if (!currentFolder.subfolders) currentFolder.subfolders = [];
            currentFolder.subfolders.push({ id: newFolderId, name: folderName });
            
            render();
            showNotification(`„Éï„Ç©„É´„ÉÄ„Äå${folderName}„Äç„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü`, 'success');
        }

        window.deleteFolder = function(folderId) {
            if (confirm('„Åì„ÅÆ„Éï„Ç©„É´„ÉÄ„Å®„Åù„ÅÆ‰∏≠Ë∫´„Çí„Åô„Åπ„Å¶ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                const feature = state.features[state.activeServerId].find(f => f.id === state.activeFeatureId);
                const content = state.content[feature.id];
                
                if (content.folders && content.folders[folderId]) {
                    const folder = content.folders[folderId];
                    const parentFolder = content.folders[folder.parentId];
                    
                    // Ë¶™„Éï„Ç©„É´„ÉÄ„ÅÆsubfolders„Åã„ÇâÂâäÈô§
                    if (parentFolder && parentFolder.subfolders) {
                        parentFolder.subfolders = parentFolder.subfolders.filter(sf => sf.id !== folderId);
                    }
                    
                    // „Éï„Ç©„É´„ÉÄËá™‰Ωì„ÇíÂâäÈô§
                    delete content.folders[folderId];
                    
                    render();
                    showNotification('„Éï„Ç©„É´„ÉÄ„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
                }
            }
        }
        
        // === „Ç≥„É≥„ÉÜ„É≥„ÉÑÊõ¥Êñ∞Ê©üËÉΩ ===
        async function updateFeatureContent(featureId, contentData) {
            try {
                const result = await apiCall('updateFeatureContent', {
                    featureId: featureId,
                    content: JSON.stringify(contentData)
                });
                
                if (result) {
                    // „É≠„Éº„Ç´„É´Áä∂ÊÖã„ÇíÊõ¥Êñ∞
                    state.content[featureId] = contentData;
                    console.log('Feature content updated:', featureId);
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Error updating feature content:', error);
                return false;
            }
        }

        // === „Éï„Ç°„Ç§„É´Êìç‰ΩúÈñ¢Êï∞ ===
        window.previewFile = function(file) {
            if (file.mimeType.startsWith('image/')) {
                // ÁîªÂÉè„Éó„É¨„Éì„É•„Éº
                showModal('file-preview', { 
                    title: file.filename,
                    content: `<img src="/files/uploads/${file.id}.${file.filename.split('.').pop()}" class="max-w-full max-h-96 mx-auto rounded-lg">`,
                    type: 'preview'
                });
            } else {
                // „Åù„ÅÆ‰ªñ„ÅÆ„Éï„Ç°„Ç§„É´Ôºà„ÉÜ„Ç≠„Çπ„Éà„Éï„Ç°„Ç§„É´„Å™„Å©Ôºâ
                showNotification('„Éó„É¨„Éì„É•„Éº„ÅØ„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'info');
            }
        };

        window.renameFile = function(fileId) {
            const file = state.files.find(f => f.id === fileId);
            if (!file) return;
            
            const newName = prompt('Êñ∞„Åó„ÅÑ„Éï„Ç°„Ç§„É´Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:', file.filename);
            if (newName && newName !== file.filename) {
                // „Åì„Åì„Åß„Çµ„Éº„Éê„Éº„Å´„É™„ÇØ„Ç®„Çπ„Éà„ÇíÈÄÅ‰ø°„Åô„ÇãÂÆüË£Ö„ÅåÂøÖË¶Å
                showNotification('„Éï„Ç°„Ç§„É´ÂêçÂ§âÊõ¥Ê©üËÉΩ„ÅØÈñãÁô∫‰∏≠„Åß„Åô', 'info');
            }
        };

        window.downloadFile = function(fileId, filename) {
            const link = document.createElement('a');
            link.href = `/files/uploads/${fileId}.${filename.split('.').pop()}`;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showNotification(`${filename} „Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü`, 'success');
        };

        // === Âè≥„ÇØ„É™„ÉÉ„ÇØ„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„É°„Éã„É•„Éº ===
        let contextMenu = null;

        function showContextMenu(e, items) {
            e.preventDefault();
            hideContextMenu();

            contextMenu = document.createElement('div');
            contextMenu.className = 'fixed bg-gray-800 border border-gray-600 rounded-lg shadow-lg py-2 z-50';
            contextMenu.style.left = e.pageX + 'px';
            contextMenu.style.top = e.pageY + 'px';

            items.forEach(item => {
                if (item.separator) {
                    const separator = document.createElement('div');
                    separator.className = 'border-t border-gray-600 my-1';
                    contextMenu.appendChild(separator);
                } else {
                    const menuItem = document.createElement('div');
                    menuItem.className = 'px-4 py-2 text-sm text-white hover:bg-gray-700 cursor-pointer flex items-center';
                    menuItem.innerHTML = `<i data-lucide="${item.icon}" class="w-4 h-4 mr-2"></i>${item.label}`;
                    menuItem.onclick = () => {
                        item.action();
                        hideContextMenu();
                    };
                    contextMenu.appendChild(menuItem);
                }
            });

            document.body.appendChild(contextMenu);

            // Lucide„Ç¢„Ç§„Ç≥„É≥„ÇíÂÜçÂàùÊúüÂåñ
            if (window.lucide) {
                window.lucide.createIcons();
            }
        }

        function hideContextMenu() {
            if (contextMenu) {
                contextMenu.remove();
                contextMenu = null;
            }
        }

        // === „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö ===
        const setupEventListeners = () => {
            // Âè≥„ÇØ„É™„ÉÉ„ÇØ„Åß„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„É°„Éã„É•„Éº„ÇíÈö†„Åô
            document.addEventListener('click', hideContextMenu);
            document.addEventListener('contextmenu', (e) => {
                if (e.target.closest('.file-item')) {
                    e.preventDefault(); // „Éá„Éï„Ç©„É´„Éà„ÅÆÂè≥„ÇØ„É™„ÉÉ„ÇØ„É°„Éã„É•„Éº„ÇíÁÑ°ÂäπÂåñ
                    const fileId = e.target.closest('.file-item').dataset.fileId;
                    const file = state.files.find(f => f.id === fileId);
                    if (file) {
                        showContextMenu(e, [
                            { icon: 'eye', label: '„Éó„É¨„Éì„É•„Éº', action: () => previewFile(file) },
                            { icon: 'download', label: '„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ', action: () => downloadFile(file.id, file.filename) },
                            { separator: true },
                            { icon: 'edit', label: 'ÂêçÂâçÂ§âÊõ¥', action: () => renameFile(file.id) },
                            { icon: 'trash-2', label: 'ÂâäÈô§', action: () => deleteFile(file.id) }
                        ]);
                    }
                }
            });

            document.body.addEventListener('click', (e) => {
                const target = e.target.closest('[data-action], [data-server-id], [data-feature-id], [data-subitem-id], [data-board-id], [data-survey-id], [data-project-id], [data-task-id]');
                if (!target) return;
                
                const { action, serverId, featureId, subitemId, boardId, surveyId, projectId, taskId } = target.dataset;

                if (action && ACTIONS[action]) {
                    e.preventDefault();
                    ACTIONS[action](target.closest('form') || target);
                } else if (serverId) {
                    e.preventDefault();
                    state.activeServerId = serverId;
                    if(serverId !== 'user-hub' && state.features[serverId] && state.features[serverId][0]) {
                        const firstFeature = state.features[serverId][0];
                        state.activeFeatureId = firstFeature.id;
                        
                        // ÈÅ©Âàá„Å™„Çµ„Éñ„Ç¢„Ç§„ÉÜ„É†„ÇíË®≠ÂÆö
                        const contentData = state.content[firstFeature.id];
                        if (firstFeature.type === 'chat' || firstFeature.type === 'forum') {
                            state.activeSubItemId = contentData?.subItems ? Object.keys(contentData.subItems)[0] : null;
                        } else if (firstFeature.type === 'whiteboard') {
                            state.activeBoardId = contentData?.boards ? Object.keys(contentData.boards)[0] : null;
                        } else if (firstFeature.type === 'survey') {
                            state.activeSurveyId = contentData?.surveys ? Object.keys(contentData.surveys)[0] : null;
                        } else if (firstFeature.type === 'projects') {
                            state.activeProjectId = contentData?.projects ? Object.keys(contentData.projects)[0] : null;
                        }
                    }
                    render();
                } else if (featureId) {
                    e.preventDefault();
                    state.activeFeatureId = featureId;
                    const contentData = state.content[featureId];
                    const feature = state.features[state.activeServerId].find(f => f.id === featureId);
                    
                    if (feature.type === 'chat' || feature.type === 'forum') {
                        state.activeSubItemId = contentData?.subItems ? Object.keys(contentData.subItems)[0] : null;
                    } else if (feature.type === 'whiteboard') {
                        state.activeBoardId = contentData?.boards ? Object.keys(contentData.boards)[0] : null;
                    } else if (feature.type === 'survey') {
                        state.activeSurveyId = contentData?.surveys ? Object.keys(contentData.surveys)[0] : null;
                    } else if (feature.type === 'projects') {
                        state.activeProjectId = contentData?.projects ? Object.keys(contentData.projects)[0] : null;
                    }
                    render();
                } else if (subitemId) {
                    e.preventDefault();
                    state.activeSubItemId = subitemId;
                    render();
                } else if (boardId) {
                    e.preventDefault();
                    state.activeBoardId = boardId;
                    render();
                } else if (surveyId) {
                    e.preventDefault();
                    state.activeSurveyId = surveyId;
                    render();
                } else if (projectId) {
                    e.preventDefault();
                    state.activeProjectId = projectId;
                    render();
                }
            });

            // „É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°ÔºàEnter „Ç≠„ÉºÔºâ
            document.body.addEventListener('keydown', async (e) => {
                if(e.key === 'Enter' && !e.shiftKey) {
                    if(e.target.dataset.action === 'post-message' && e.target.value.trim() !== '') {
                        e.preventDefault();
                        const data = await apiCall('postMessage', { 
                            featureId: state.activeFeatureId, 
                            subItemId: state.activeSubItemId, 
                            content: e.target.value.trim() 
                        });
                        if(data) {
                            // Merge returned state, preserve active ids
                            const currentActiveServerId = state.activeServerId;
                            const currentActiveFeatureId = state.activeFeatureId;
                            const currentActiveSubItemId = state.activeSubItemId;
                            try { Object.keys(data).forEach(k => state[k] = data[k]); } catch (e) { state = data; }
                            state.activeServerId = currentActiveServerId;
                            state.activeFeatureId = currentActiveFeatureId;
                            state.activeSubItemId = currentActiveSubItemId;
                            state.currentUser = data.currentUser || state.currentUser;
                            window.state = state;
                            render();
                            
                            e.target.value = '';
                        }
                    } else if(e.target.dataset.action === 'post-forum-message' && e.target.value.trim() !== '') {
                        e.preventDefault();
                        const data = await apiCall('postMessage', { 
                            featureId: state.activeFeatureId, 
                            subItemId: state.activeSubItemId, 
                            content: e.target.value.trim() 
                        });
                        if(data) {
                            // Merge returned state, preserve active ids
                            const currentActiveServerId = state.activeServerId;
                            const currentActiveFeatureId = state.activeFeatureId;
                            const currentActiveSubItemId = state.activeSubItemId;
                            try { Object.keys(data).forEach(k => state[k] = data[k]); } catch (e) { state = data; }
                            state.activeServerId = currentActiveServerId;
                            state.activeFeatureId = currentActiveFeatureId;
                            state.activeSubItemId = currentActiveSubItemId;
                            state.currentUser = data.currentUser || state.currentUser;
                            window.state = state;
                            render();
                            
                            e.target.value = '';
                        }
                    }
                }
            });

            // „Éï„Ç©„Éº„É†ÈÄÅ‰ø°„Éè„É≥„Éâ„É™„É≥„Ç∞Ôºà„É≠„Ç∞„Ç§„É≥„ÉªÁôªÈå≤„Éª„Ç¢„É≥„Ç±„Éº„ÉàÔºâ
            document.body.addEventListener('submit', async (e) => {
                // „É≠„Ç∞„Ç§„É≥ / ÁôªÈå≤„Éï„Ç©„Éº„É†
                if (e.target.id === 'login-form' || e.target.id === 'register-form') {
                    e.preventDefault();
                    const formEl = e.target;
                    if (formEl.id === 'login-form') {
                        await ACTIONS.login(formEl);
                    } else {
                        await ACTIONS.register(formEl);
                    }
                    return;
                }

                // „Ç¢„É≥„Ç±„Éº„ÉàÈÄÅ‰ø°
                if(e.target.id === 'survey-form') {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const responses = {};
                    
                    for(const [key, value] of formData.entries()) {
                        if(key.startsWith('q')) {
                            const questionId = key.substring(1);
                            if(!responses[questionId]) responses[questionId] = [];
                            responses[questionId].push(value);
                        }
                    }
                    
                    // Âçò‰∏ÄÂõûÁ≠î„ÅÆÂ†¥Âêà„ÅØÈÖçÂàó„Åã„ÇâÊñáÂ≠óÂàó„Å´Â§âÊèõ
                    Object.keys(responses).forEach(qId => {
                        if(responses[qId].length === 1) {
                            responses[qId] = responses[qId][0];
                        }
                    });

                    const content = state.content[state.activeFeatureId] || {};
                    if (content.surveys && content.surveys[state.activeSurveyId]) {
                        // ÂõûÁ≠î„ÇíËøΩÂä†
                        if (!content.surveys[state.activeSurveyId].responses) {
                            content.surveys[state.activeSurveyId].responses = [];
                        }
                        
                        content.surveys[state.activeSurveyId].responses.push({
                            id: Date.now().toString(),
                            responses: responses,
                            respondent: state.currentUser.username,
                            submitted_at: Date.now() / 1000
                        });
                        
                        // „Çµ„Éº„Éê„Éº„Å´‰øùÂ≠ò
                        const saved = await updateFeatureContent(state.activeFeatureId, content);
                        if (saved) {
                            render();
                            showNotification('„Ç¢„É≥„Ç±„Éº„ÉàÂõûÁ≠î„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü', 'success');
                        } else {
                            showNotification('ÂõûÁ≠î„ÅÆÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                        }
                    }
                }
            });

            // „Ç¶„Ç£„É≥„Éâ„Ç¶„É™„Çµ„Ç§„Ç∫ÊôÇ„ÅÆ„Éõ„ÉØ„Ç§„Éà„Éú„Éº„ÉâË™øÊï¥
            window.addEventListener('resize', () => {
                if(currentWhiteboardCanvas) {
                    const canvas = document.getElementById('whiteboard-canvas');
                    if(canvas) {
                        currentWhiteboardCanvas.setDimensions({
                            width: canvas.parentElement.clientWidth,
                            height: canvas.parentElement.clientHeight
                        });
                    }
                }
            });
        };
        
        // === „É°„Ç§„É≥Èñ¢Êï∞ ===
        async function main() {
            setupEventListeners();
            const data = await apiCall('checkSession');
            if (data && data.loggedIn && data.state) {
                initializeApp(data.state);
                showNotification('„Çª„ÉÉ„Ç∑„Éß„É≥„ÅåÂæ©ÂÖÉ„Åï„Çå„Åæ„Åó„Åü', 'success');
            } else {
                showAuth('login');
            }
        }

        // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞ÂÆöÁæ©ÔºàHTML„Åã„ÇâÂëº„Å≥Âá∫„Åï„Çå„ÇãÔºâ
        window.editWikiPage = function() {
            state.isEditingWiki = true;
            render();
        };

        window.saveWikiPage = async function() {
            const title = document.getElementById('wiki-title-edit')?.innerText || '';
            const content = document.getElementById('wiki-content-edit')?.value || '';
            
            if (!title.trim()) {
                showNotification('„Çø„Ç§„Éà„É´„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }

            const currentContent = state.content[state.activeFeatureId] || {};
            if (currentContent.pages && currentContent.pages[state.activeWikiPageId]) {
                currentContent.pages[state.activeWikiPageId].title = title;
                currentContent.pages[state.activeWikiPageId].content = content;
                currentContent.pages[state.activeWikiPageId].updated_at = Date.now() / 1000;
                
                // „Çµ„Éº„Éê„Éº„Å´‰øùÂ≠ò
                const saved = await updateFeatureContent(state.activeFeatureId, currentContent);
                if (saved) {
                    state.isEditingWiki = false;
                    render();
                    showNotification('Wiki„Éö„Éº„Ç∏„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü', 'success');
                } else {
                    showNotification('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                }
            }
        };

        window.cancelWikiEdit = function() {
            state.isEditingWiki = false;
            render();
        };

        window.deleteWikiPage = async function(pageId) {
            if (confirm('„Åì„ÅÆWiki„Éö„Éº„Ç∏„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                const content = state.content[state.activeFeatureId] || {};
                if (content.pages && content.pages[pageId]) {
                    delete content.pages[pageId];
                    
                    // „Çµ„Éº„Éê„Éº„Å´‰øùÂ≠ò
                    const saved = await updateFeatureContent(state.activeFeatureId, content);
                    if (saved) {
                        // ‰ªñ„ÅÆ„Éö„Éº„Ç∏„Åå„ÅÇ„Çå„Å∞ÊúÄÂàù„ÅÆ„ÇÇ„ÅÆ„ÇíÈÅ∏Êäû
                        const remainingPages = Object.keys(content.pages || {});
                        state.activeWikiPageId = remainingPages.length > 0 ? remainingPages[0] : null;
                        
                        render();
                        showNotification('Wiki„Éö„Éº„Ç∏„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
                    } else {
                        showNotification('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                    }
                }
            }
        };

        window.createNewWikiPage = async function() {
            await ACTIONS['create-wiki-page']();
        };

        // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÈñãÂßã
        main();
    })();
</script>
</body>
</html>